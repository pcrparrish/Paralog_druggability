---
title: "SL_paralog_feature_analysis"
author: "Phoebe Parrish"
date: "2021-07-30"
output: html_document
---

## To Do
* update depmap version - use more recent data (I am currently using 19Q1)
* do quartile analysis similar to what James did

## Setup

```{r setup, include=FALSE}

library(biomaRt)
library(depmap)
library(ExperimentHub)
library(tidyverse)
library(ggrepel)
library(ggforce)
library(ggsignif)
library(RColorBrewer)
library(ggpubr) # another way to do significance bars
library(ggprism) # another significance bar package...

```


### Assign variables
```{r}

date <- Sys.Date()

## work laptop
base_dir <- file.path("/Users", "pparrish", "Google_Drive", "01_Research", "01_Projects", "01_Paralog_pgRNA",
                      "01_Data", "Paralog_SL_meta_analysis")

## personal laptop
# base_dir <- file.path("/Users", "phoebeparrish", "Google_Drive", "01_Research", "01_Projects", "01_Paralog_pgRNA",
#                       "01_Data", "Paralog_SL_meta_analysis")

in_dir <- file.path(base_dir, "01_input_files")

out_dir <- file.path(base_dir, "02_output_files")


```


### Import files

```{r, message = FALSE}

d.DeKegel <- read_csv(file.path(in_dir, "DeKegel_Table_S8.csv"))

d.Parrish <- read_rds(file.path(in_dir, "d.PC9_v_HeLa_paralog_target_GI_wide_flag"))

d.Dede <- read_tsv(file.path(in_dir, "Dede_Table_S2.txt"))

d.druggable <- read_tsv(file.path(in_dir, "finan_druggability_with_ensembl_id.txt"))

d.Broad_drug_info <- read_csv(file.path(in_dir, "primary-screen-replicate-collapsed-treatment-info.csv"))

d.Broad_secondary_auc <- read_csv(file.path(in_dir, "secondary-screen-dose-response-curve-parameters.csv"))

d.Broad_secondary_doses <- read_csv(file.path(in_dir, "secondary-screen-dose-response-curve-parameters.csv"))

```

## Analysis

### Get Ensembl IDs and merge

```{r}

d.DeKegel <- d.DeKegel %>%
  unite(ensembl_pair, c(A1_ensembl, A2_ensembl), sep = "_", remove = FALSE) 

d.Parrish <- d.Parrish %>%
  rename(ensembl_pair_1 = ensembl_paralog_pair) %>%
  unite(ensembl_pair_2, c(target2_ensembl_id, target1_ensembl_id), sep = "_", remove = FALSE)

```

```{r}

# d.Dede %>%
#   separate(gene_pair, c("gene1", "gene2"), sep = "_") %>%
  

```


```{r}

d.Parrish_DeKegel_1 <- inner_join(d.Parrish, d.DeKegel, by = c("ensembl_pair_1" = "ensembl_pair"))
d.Parrish_DeKegel_1

d.Parrish_DeKegel_2 <- inner_join(d.Parrish, d.DeKegel, by = c("ensembl_pair_2" = "ensembl_pair"))
d.Parrish_DeKegel_2

d.Parrish_DeKegel <- bind_rows(d.Parrish_DeKegel_1, d.Parrish_DeKegel_2)
d.Parrish_DeKegel

```


```{r}

d.Parrish_DeKegel <- d.Parrish_DeKegel %>%
  mutate(top_5_percent_flag = ifelse(prediction_percentile < 5, TRUE, FALSE)) %>%
  mutate(comp_validated_flag = ifelse(broad_SL_flag != "SL_in_neither" & 
                                        top_5_percent_flag == TRUE, TRUE, FALSE)) 

d.Parrish_DeKegel_high_conf <- d.Parrish_DeKegel %>%
  filter(broader_SL_flag == "SL_in_both" & comp_validated_flag == TRUE) %>%
  rowwise() %>%
  mutate(mean_GI_score = mean(c(PC9_gene_gene_GI_score, HeLa_gene_gene_GI_score)))
d.Parrish_DeKegel_high_conf

d.Parrish_DeKegel_medium_conf <- d.Parrish_DeKegel %>%
  filter(comp_validated_flag == TRUE)

```

### Druggability

Intersect high-confidence hits (screens + depmap predictions?) with druggability...
```{r}

d.druggable
d.DeKegel

d.tmp <- d.druggable %>%
  dplyr::select(ensembl_gene_id, druggability_tier)

d.DeKegel_drug <- left_join(d.DeKegel, d.tmp, by = c("A1_ensembl" = "ensembl_gene_id")) %>%
  rename(A1_drug_tier = druggability_tier) %>%
  left_join(d.tmp, by = c("A2_ensembl" = "ensembl_gene_id")) %>%
  rename(A2_drug_tier = druggability_tier)
d.DeKegel_drug

d.DeKegel_drug <- d.DeKegel_drug %>%
  mutate(druggable_flag = case_when(
    is.na(A2_drug_tier) ~ FALSE,
    is.na(A2_drug_tier) ~ FALSE,
    TRUE ~ TRUE), 
    top_5_percent = ifelse(prediction_percentile < 5, TRUE, FALSE)) %>%
  mutate(top_5_SL_ge_1_screen = case_when(
      top_5_percent == TRUE & n_screens_SL > 0 ~ TRUE,
      TRUE ~ FALSE)) %>%
  mutate(SL_screen_ratio = n_screens_SL / n_screens) %>%
  mutate(top_5_SL_all_screens = case_when(
    top_5_percent == TRUE & SL_screen_ratio == 1 ~ TRUE,
    TRUE ~ FALSE))

```

```{r}

## druggable & top 5th percentile
d.DeKegel_drug %>%
  group_by(top_5_percent, druggable_flag) %>%
  summarize(n = n())

d.DeKegel_drug %>%
  filter(top_5_percent == TRUE) %>%
  filter(druggable_flag == TRUE)

## druggable, top 5th percentile, and SL in â‰¥1 screen
d.DeKegel_drug %>%
  group_by(top_5_SL_ge_1_screen, druggable_flag) %>%
  summarize(n = n())

d.DeKegel_drug %>%
  filter(top_5_SL_ge_1_screen == TRUE) %>%
  filter(druggable_flag == TRUE)

## druggable, top 5th percentile, and SL in all screens 
d.DeKegel_drug %>%
  group_by(top_5_SL_all_screens, druggable_flag) %>%
  summarize(n = n())

d.DeKegel_drug %>%
  filter(top_5_SL_all_screens == TRUE) %>%
  filter(druggable_flag == TRUE)

```

Next, since there are not many druggable paralogs that have been SL in multiple screens, I decided to look at the proportion of overall paralogs included in the De Kegel study that were screened at all: 
```{r}

d.DeKegel %>%
  mutate(screened_flag = ifelse(n_screens >= 1, TRUE, FALSE)) %>%
  ggplot(aes(x = screened_flag, fill = screened_flag)) +
  geom_bar(position = "identity", color = "black") +
  theme_classic () + 
  theme(aspect.ratio = 0.75, 
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"))

d.DeKegel %>%
  mutate(screened_flag = ifelse(n_screens >= 1, TRUE, FALSE)) %>%
  group_by(screened_flag) %>%
  summarize(prop_screened = (n()/nrow(d.DeKegel))) %>%
  mutate(group_label = paste0(round(100 * prop_screened, 2), "%")) %>%
  ungroup() %>%
  arrange(prop_screened) %>%
  ggplot(aes(x = "", y = prop_screened, fill = screened_flag)) +
  geom_bar(stat = "identity", width = 1, color = "white") +
  coord_polar("y", start = 0) +
  theme_void() +
  geom_text(aes(x = 1, y = cumsum(prop_screened) - prop_screened/2, label = group_label))

```
So only ~5% of all paralogs have been included in CRISPR screens to date. This does not include the new loss of Y paper that came out, but that screened a limited number of druggable genes I think. 


#### DepMap drug data
Also see: https://depmap.org/repurposing/
```{r}

# eh <- ExperimentHub()
# eh.depmap <- query(eh, "depmap")
# 
# # drug_sensitivity <- eh[["EH3087"]]
# 
# # metadata <- read_rds(file.path(in_dir, "depmap_metadata"))
# 
# foo = tibble("eh_id" = names(eh.depmap),
#              "title" = eh.depmap$title)
# foo %>% print(n = Inf)

```

```{r, include=FALSE}

# ## use this the first time only
# crispr <- eh[["EH6118"]]
# mut_calls <- eh[["EH6121"]]
# metadata <- eh[["EH6122"]]
# cn <- eh[["EH6119"]]
# expr <- eh[["EH6120"]]
# 
# drug_sensitivity <- eh[["EH3087"]]
# drug_metadata <- eh[["EH3086"]]
# ## note: drug info is from 19Q4, these are 19Q3
# 
# ## read in RDS files
# crispr <- read_rds(file.path(in_dir, "depmap_crispr"))
# # mutationCalls <- read_rds(file.path(in_dir, "depmap_mutationCalls"))
# # metadata <- read_rds(file.path(in_dir, "depmap_metadata"))
# copyNumber <- read_rds(file.path(in_dir, "depmap_copyNumber"))
# expr <- read_rds(file.path(in_dir, "depmap_expr"))
# 
# # write_rds(crispr, file.path(in_dir, "depmap_crispr"))
# # write_rds(mutationCalls, file.path(in_dir, "depmap_mutationCalls"))
# # write_rds(metadata, file.path(in_dir, "depmap_metadata"))
# # write_rds(copyNumber, file.path(in_dir, "depmap_copyNumber"))
# # write_rds(expr, file.path(in_dir, "depmap_expr"))

```



```{r, include=FALSE}

# drug_sensitivity
# expr
# 
# ggplot(expr, aes(x = rna_expression)) +
#   geom_histogram(binwidth = 0.5, color = "black", fill = "gray") +
#   geom_vline(xintercept = 1.5, color = "red", linetype = "dashed") +
#   theme_classic() + 
#   theme(aspect.ratio = 0.75, 
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"))
# # ggsave(file.path(out_dir, "depmap_rna_expr_allCellLines_allGenes.png"),
# #        width = 4.5, height = 3)

```


```{r, include=FALSE}

# copyNumber

# cn
# 
# median(cn$log_copy_number, na.rm = TRUE)
# 
# # cn %>%
# #   summarize(median_cn = median(log_copy_number))
# 
# ggplot(cn, aes(x = log_copy_number)) +
#   geom_histogram(binwidth = 0.25, color = "black", fill = "gray") +
#   # geom_vline(xintercept = 1.5, color = "red", linetype = "dashed") +
#   theme_classic() +
#   theme(aspect.ratio = 0.75,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"))
# # ggsave(file.path(out_dir, "depmap_cn_allCellLines_allGenes.png"),
# #        width = 4.5, height = 3)

```

Expression (red line indicates TPM = 1.5): 
![Histogram of RNA expression for all genes across all DepMap cell lines.](file.path(out_dir, "depmap_rna_expr_allCellLines_allGenes.png"))

Copy number: 
![Histogram of copy number for all genes across all DepMap cell lines.](file.path(out_dir, "depmap_cn_allCellLines_allGenes.png"))

Cutoffs to apply: 
* expression: >1.5 log2(TPM) = expressed
* copy number: >1.5 log_copy_number = copy gain, < 0.5??? = copy loss

##### Get gene list

###### Top 5%
```{r}

DeKegel_top5_genes_entrez <- d.DeKegel %>%
  filter(prediction_percentile < 5) %>%
  dplyr::select(A1_entrez, A2_entrez) %>%
  gather() %>%
  distinct(value) %>%
  pull(value)

DeKegel_top5_genes_hgnc <- d.DeKegel %>%
  filter(prediction_percentile < 5) %>%
  dplyr::select(A1, A2) %>%
  gather() %>%
  distinct(value) %>%
  pull(value)
  
```

```{r, include=FALSE}

# metadata
# 
# d.expr_DeKegel_top5 <- expr %>%
#   dplyr::filter(entrez_id %in% DeKegel_top5_genes_entrez) 
# d.expr_DeKegel_top5
# 
# d.cn_DeKegel_top5 <- cn %>%
#   dplyr::filter(entrez_id %in% DeKegel_top5_genes_entrez)
# d.cn_DeKegel_top5
# 
# d.mut_DeKegel_top5 <- mut_calls %>%
#   dplyr::filter(entrez_id %in% DeKegel_top5_genes_entrez)
# d.mut_DeKegel_top5
# 
# # write_rds(metadata, file.path(out_dir, "d.metadata_21Q2"))
# # write_rds(d.expr_DeKegel_top5, file.path(out_dir, "d.expr_21Q2_DeKegel_top5"))
# # write_rds(d.cn_DeKegel_top5, file.path(out_dir, "d.cn_21Q2_DeKegel_top5"))
# # write_rds(d.mut_DeKegel_top5, file.path(out_dir, "d.mut_21Q2_DeKegel_top5"))

```

```{r}

# metadata <- read_rds(file.path(out_dir, "d.metadata_21Q2"))
# d.expr_top5 <- read_rds(file.path(out_dir, "d.expr_21Q2_DeKegel_top5"))
# d.cn_top5 <- read_rds(file.path(out_dir, "d.cn_21Q2_DeKegel_top5"))
# d.mut_top5 <- read_rds(filepath(out_dir, "d.mut_21Q2_DeKegel_top5"))

```

###### Top 5% and druggable
```{r}

d.DeKegel_top5_druggable <- d.DeKegel_drug %>%
  filter(top_5_percent == TRUE) %>%
  filter(druggable_flag == TRUE)
d.DeKegel_top5_druggable

d.DeKegel_top5_druggable <- d.DeKegel_drug %>%
  filter(top_5_percent == TRUE) %>%
  filter(druggable_flag == TRUE)
d.DeKegel_top5_druggable

top5_druggable_genes_entrez <- d.DeKegel_top5_druggable %>%
  dplyr::select(A1_entrez, A2_entrez) %>%
  gather() %>%
  distinct(value) %>%
  pull(value)

top5_druggable_genes_hgnc <- d.DeKegel_top5_druggable %>%
  dplyr::select(A1, A2) %>%
  gather() %>%
  distinct(value) %>%
  pull(value)

```

```{r}

# metadata
# 
# d.expr_top5_drug <- expr %>%
#   dplyr::filter(entrez_id %in% top5_druggable_genes_entrez) 
# d.expr_top5_drug
# 
# d.cn_top5_drug <- cn %>%
#   dplyr::filter(entrez_id %in% top5_druggable_genes_entrez)
# d.cn_top5_drug
# 
# d.mut_top5_drug <- mut_calls %>%
#   dplyr::filter(entrez_id %in% top5_druggable_genes_entrez)
# d.mut_top5_drug
# ## is_deleterious = key column
# 
# # write_rds(d.expr_top5_drug, file.path(out_dir, "d.expr_21Q2_DeKegel_top5_druggable"))
# # write_rds(d.cn_top5_drug, file.path(out_dir, "d.cn_21Q2_DeKegel_top5_druggable"))
# # write_rds(d.mut_top5_drug, file.path(out_dir, "d.mut_21Q2_DeKegel_top5_druggable"))

```

```{r}

# d.Broad_drug_info %>%
#   dplyr::filter(grepl("CDK4", target))
# 
# d.Broad_drug_info
# 
# d.Broad_drug_info %>%
#   dplyr::filter(grepl(str_c(top5_druggable_genes_hgnc, collapse = "|"), target))
# 
# drug_list <- d.Broad_drug_info %>%
#   dplyr::filter(grepl(str_c(top5_druggable_genes_hgnc, collapse = "|"), target)) %>%
#   distinct(column_name) %>%
#   dplyr::pull(column_name)
# 
# drug_list
# 
# # str_c(top5_druggable_genes_hgnc, collapse = "|")
# 
# # drug_sensitivity
# 
# d.drug_sens_filtered <- drug_sensitivity %>%
#   dplyr::filter(compound %in% drug_list) %>%
#   left_join(d.Broad_drug_info, by = c("compound" = "column_name"))
# d.drug_sens_filtered
# 
# # write_rds(d.drug_sens_filtered, file.path(out_dir, "d.drug_sens_19Q3_DeKegel_top5_druggable"))
# # write_rds(drug_metadata, file.path(out_dir, "d.metadata_19Q3"))

```

```{r}

## 21Q2 datasets
metadata <- read_rds(file.path(out_dir, "d.metadata_21Q2"))
d.expr_top5 <- read_rds(file.path(out_dir, "d.expr_21Q2_DeKegel_top5"))
d.expr_top5_drug <- read_rds(file.path(out_dir, "d.expr_21Q2_DeKegel_top5_druggable"))
d.cn_top5 <- read_rds(file.path(out_dir, "d.cn_21Q2_DeKegel_top5"))
d.cn_top5_drug <- read_rds(file.path(out_dir, "d.cn_21Q2_DeKegel_top5_druggable"))
d.mut_top5 <- read_rds(file.path(out_dir, "d.mut_21Q2_DeKegel_top5"))
d.mut_top5_drug <- read_rds(file.path(out_dir, "d.mut_21Q2_DeKegel_top5_druggable"))

## 19Q3 datasets
drug_metadata <- read_rds(file.path(out_dir, "d.metadata_19Q3"))
d.drug_sens_filtered <- read_rds(file.path(out_dir, "d.drug_sens_19Q3_DeKegel_top5_druggable"))

```

###### CDK4/6 test case
```{r}

# d.Broad_drug_info %>%
#   dplyr::filter(grepl("CDK4", target))
# 
# d.Broad_drug_info
# 
# d.Broad_drug_info %>%
#   dplyr::filter(grepl(str_c(top5_druggable_genes_hgnc, collapse = "|"), target))
# 
# drug_list <- d.Broad_drug_info %>%
#   dplyr::filter(grepl(str_c(top5_druggable_genes_hgnc, collapse = "|"), target)) %>%
#   distinct(column_name) %>%
#   dplyr::pull(column_name)
# 
# drug_list
# 
# # str_c(top5_druggable_genes_hgnc, collapse = "|")
# 
# # drug_sensitivity
# 
# d.drug_sens_filtered <- drug_sensitivity %>%
#   dplyr::filter(compound %in% drug_list) %>%
#   left_join(d.Broad_drug_info, by = c("compound" = "column_name"))
# d.drug_sens_filtered

```

```{r}

## test case
d.drug_sens_filtered %>%
  filter(grepl("CDK4", target))

d.drug_CDK4 <- d.drug_sens_filtered %>%
  filter(grepl("CDK4", target))

d.drug_CDK6 <- d.drug_sens_filtered %>%
  filter(grepl("CDK6", target))

d.expr_top5_drug %>%
  filter(gene_name == "CDK4" | gene_name == "CDK6") %>%
  ggplot(aes(x = rna_expression, fill = gene_name)) +
  geom_histogram(binwidth = 0.5, color = "black", alpha = 0.75)+
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") + 
  facet_wrap(~gene_name)

d.expr_CDK4 <- d.expr_top5_drug %>%
  filter(gene_name == "CDK4") %>%
  group_by(gene_name) %>%
  mutate(bin_tpm = ntile(rna_expression, 4)) %>%
  mutate(bin_tpm = factor(bin_tpm, levels = c(4, 3, 2, 1))) %>%
  ungroup()
d.expr_CDK4

d.expr_CDK6 <- d.expr_top5_drug %>%
  filter(gene_name == "CDK6") %>%
  group_by(gene_name) %>%
  mutate(bin_tpm = ntile(rna_expression, 4)) %>%
  mutate(bin_tpm = factor(bin_tpm, levels = c(4, 3, 2, 1))) %>%
  ungroup()
d.expr_CDK6

d.CDK4_expr_CDK6_drug <- left_join(d.expr_CDK4, d.drug_CDK6, by = "depmap_id") %>%
  filter(!is.na(compound))
d.CDK4_expr_CDK6_drug

d.CDK6_expr_CDK4_drug <- left_join(d.expr_CDK6, d.drug_CDK4, by = "depmap_id") %>%
  filter(!is.na(compound))
d.CDK6_expr_CDK4_drug

# d.cn_top5_drug %>%
#   filter(gene_name == "CDK4" | gene_name == "CDK6") %>%
#   ggplot(aes(x = log_copy_number)) +
#   geom_histogram()

```



```{r}

## CDK4 expression vs. drugs targeting CDK6

d.CDK4_expr_CDK6_drug
ggplot(d.CDK4_expr_CDK6_drug, aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.CDK4_expr_CDK6_drug %>%
  filter(grepl("BREAST", cell_line.x)) %>%
  ggplot(aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.CDK4_expr_CDK6_drug %>%
  filter(bin_tpm %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_tpm, alternative = "greater")$p.value)

d.CDK4_expr_CDK6_drug %>%
  group_by(bin_tpm) %>%
  filter(!is.na(dependency)) %>%
  summarize(median = median(rna_expression))

```


```{r}

## CDK6 expression vs. drugs targeting CDK4

d.CDK6_expr_CDK4_drug
ggplot(d.CDK6_expr_CDK4_drug, aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.CDK6_expr_CDK4_drug %>%
  filter(bin_tpm %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_tpm, alternative = "greater")$p.value)


d.CDK6_expr_CDK4_drug %>%
  filter(grepl("BREAST", cell_line.x)) %>%
  ggplot(aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

# d.CDK6_expr_CDK4_drug %>%
#   filter(grepl("BREAST", cell_line.x)) %>%
#   filter(bin_tpm %in% c(1, 4)) %>%
#   group_by(name) %>%
#   summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_tpm, alternative = "greater")$p.value)

d.CDK6_expr_CDK4_drug %>%
  filter(grepl("LUNG", cell_line.x)) %>%
  ggplot(aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

```

```{r}

d.cn_top5_drug %>%
  filter(gene_name == "CDK4" | gene_name == "CDK6") %>%
  ggplot(aes(x = log_copy_number, fill = gene_name)) +
  geom_histogram(binwidth = 0.25, color = "black", alpha = 0.75)+
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") + 
  facet_wrap(~gene_name)

d.cn_CDK4 <- d.cn_top5_drug %>%
  filter(gene_name == "CDK4") %>%
  group_by(gene_name) %>%
  mutate(bin_cn = ntile(log_copy_number, 4)) %>%
  mutate(bin_cn = factor(bin_cn, levels = c(4, 3, 2, 1))) %>%
  ungroup()
d.cn_CDK4

d.cn_CDK6 <- d.cn_top5_drug %>%
  filter(gene_name == "CDK6") %>%
  group_by(gene_name) %>%
  mutate(bin_cn = ntile(log_copy_number, 4)) %>%
  mutate(bin_cn = factor(bin_cn, levels = c(4, 3, 2, 1))) %>%
  ungroup()
d.cn_CDK6

d.CDK4_cn_CDK6_drug <- left_join(d.cn_CDK4, d.drug_CDK6, by = "depmap_id") %>%
  filter(!is.na(compound))
d.CDK4_cn_CDK6_drug

d.CDK6_cn_CDK4_drug <- left_join(d.cn_CDK6, d.drug_CDK4, by = "depmap_id") %>%
  filter(!is.na(compound))
d.CDK6_cn_CDK4_drug

```

```{r}

d.CDK4_cn_CDK6_drug
ggplot(d.CDK4_cn_CDK6_drug, aes(x = bin_cn, y = dependency, fill = bin_cn)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.CDK4_cn_CDK6_drug %>%
  filter(grepl("BREAST", cell_line.x)) %>%
  ggplot(aes(x = bin_cn, y = dependency, fill = bin_cn)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.CDK4_cn_CDK6_drug %>%
  filter(bin_cn %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_cn, alternative = "greater")$p.value)

d.CDK4_cn_CDK6_drug %>%
  group_by(bin_cn) %>%
  filter(!is.na(dependency)) %>%
  summarize(median = median(log_copy_number))

d.CDK6_cn_CDK4_drug
ggplot(d.CDK6_cn_CDK4_drug, aes(x = bin_cn, y = dependency, fill = bin_cn)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.CDK6_cn_CDK4_drug %>%
  filter(grepl("BREAST", cell_line.x)) %>%
  ggplot(aes(x = bin_cn, y = dependency, fill = bin_cn)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.CDK6_cn_CDK4_drug %>%
  filter(grepl("BREAST", cell_line.x))%>%
  filter(bin_cn %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_cn, alternative = "greater")$p.value)


```

###### Lung test cases
```{r}

d.drug_sens_filtered %>%
  filter(grepl("lung", indication)) %>%
  dplyr::select(compound,name:phase) %>%
  distinct(compound, .keep_all = TRUE)

```

```{r}

## RRM2, RRM2B w/ gemcitabine (targets RRM2)
gene1 <- "RRM2"
gene2 <- "RRM2B"
d.cn_top5_drug %>%
  filter(gene_name == gene1 | gene_name == gene2) %>%
  ggplot(aes(x = log_copy_number, fill = gene_name)) +
  geom_histogram(binwidth = 0.1, color = "black", alpha = 0.75)+
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") + 
  facet_wrap(~gene_name)

d.expr_top5_drug %>%
  filter(gene_name == gene1 | gene_name == gene2) %>%
  ggplot(aes(x = rna_expression, fill = gene_name)) +
  geom_histogram(binwidth = 0.5, color = "black", alpha = 0.75)+
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") + 
  facet_wrap(~gene_name)

# d.drug_gene1 <- d.drug_sens_filtered %>%
#   filter(grepl(gene1, target))
# d.drug_gene1

# d.drug_gene2 <- d.drug_sens_filtered %>%
#   filter(grepl(gene2, target))
# d.drug_gene2

d.drug_gene1 <- d.drug_sens_filtered %>%
  filter(name == "gemcitabine")

d.expr_gene1 <- d.expr_top5_drug %>%
  filter(gene_name == gene1) %>%
  group_by(gene_name) %>%
  mutate(bin_tpm = ntile(rna_expression, 4)) %>%
  mutate(bin_tpm = factor(bin_tpm, levels = c(4, 3, 2, 1))) %>%
  ungroup()

d.expr_gene2 <- d.expr_top5_drug %>%
  filter(gene_name == gene2) %>%
  group_by(gene_name) %>%
  mutate(bin_tpm = ntile(rna_expression, 4)) %>%
  mutate(bin_tpm = factor(bin_tpm, levels = c(4, 3, 2, 1))) %>%
  ungroup()

# d.gene1_expr_gene2_drug <- left_join(d.expr_gene1, d.drug_gene2, by = "depmap_id") %>%
#   filter(!is.na(compound))

d.gene2_expr_gene1_drug <- left_join(d.expr_gene2, d.drug_gene1, by = "depmap_id") %>%
  filter(!is.na(compound))

ggplot(d.gene2_expr_gene1_drug, aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.gene2_expr_gene1_drug %>%
  filter(bin_tpm %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_tpm, alternative = "greater")$p.value)

d.gene2_expr_gene1_drug_lung <- d.expr_top5_drug %>%
  filter(grepl("LUNG", cell_line)) %>%
  filter(gene_name == gene2) %>%
  group_by(gene_name) %>%
  mutate(bin_tpm = ntile(rna_expression, 4)) %>%
  mutate(bin_tpm = factor(bin_tpm, levels = c(4, 3, 2, 1))) %>%
  ungroup() %>%
  left_join(d.drug_gene1, by = "depmap_id") %>%
  filter(!is.na(compound))

d.expr_top5_drug

d.gene2_expr_gene1_drug_lung %>%
  ggplot(aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.gene2_expr_gene1_drug_lung %>%
  filter(bin_tpm %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_tpm, alternative = "greater")$p.value)

```


```{r}


## TUBB, TUBB1 and vindesine (targets both genes)
gene1 <- "TUBB"
gene2 <- "TUBB1"
d.cn_top5_drug %>%
  filter(gene_name == gene1 | gene_name == gene2) %>%
  ggplot(aes(x = log_copy_number, fill = gene_name)) +
  geom_histogram(binwidth = 0.1, color = "black", alpha = 0.75)+
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") + 
  facet_wrap(~gene_name)

d.expr_top5_drug %>%
  filter(gene_name == gene1 | gene_name == gene2) %>%
  ggplot(aes(x = rna_expression, fill = gene_name)) +
  geom_histogram(binwidth = 0.5, color = "black", alpha = 0.75)+
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") + 
  facet_wrap(~gene_name)

d.drug_gene1 <- d.drug_sens_filtered %>%
  filter(name == "vindesine")

d.drug_gene2 <- d.drug_sens_filtered %>%
  filter(name == "vindesine")

d.expr_gene1 <- d.expr_top5_drug %>%
  filter(gene_name == gene1) %>%
  group_by(gene_name) %>%
  mutate(bin_tpm = ntile(rna_expression, 4)) %>%
  mutate(bin_tpm = factor(bin_tpm, levels = c(4, 3, 2, 1))) %>%
  ungroup()

d.expr_gene2 <- d.expr_top5_drug %>%
  filter(gene_name == gene2) %>%
  group_by(gene_name) %>%
  mutate(bin_tpm = ntile(rna_expression, 4)) %>%
  mutate(bin_tpm = factor(bin_tpm, levels = c(4, 3, 2, 1))) %>%
  ungroup()

d.gene1_expr_gene2_drug <- left_join(d.expr_gene1, d.drug_gene2, by = "depmap_id") %>%
  filter(!is.na(compound))

d.gene2_expr_gene1_drug <- left_join(d.expr_gene2, d.drug_gene1, by = "depmap_id") %>%
  filter(!is.na(compound))

## TUBB1 expr, TUBB dependency
ggplot(d.gene2_expr_gene1_drug, aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.gene2_expr_gene1_drug %>%
  filter(bin_tpm %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_tpm, alternative = "greater")$p.value)


d.gene2_expr_gene1_drug %>%
  filter(grepl("LUNG", cell_line.x)) %>%
  ggplot(aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.gene2_expr_gene1_drug %>%
  filter(grepl("LUNG", cell_line.x)) %>%
  filter(bin_tpm %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_tpm, alternative = "greater")$p.value)

## TUBB expr, TUBB1 dependency
ggplot(d.gene1_expr_gene2_drug, aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.gene1_expr_gene2_drug %>%
  filter(bin_tpm %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_tpm, alternative = "greater")$p.value)


d.gene1_expr_gene2_drug %>%
  filter(grepl("LUNG", cell_line.x)) %>%
  ggplot(aes(x = bin_tpm, y = dependency, fill = bin_tpm)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.gene1_expr_gene2_drug %>%
  filter(grepl("LUNG", cell_line.x)) %>%
  filter(bin_tpm %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_tpm, alternative = "greater")$p.value)

```

```{r}

## TOP2A, TOP2B and etoposide (targets both genes)
gene1 <- "TOP2A"
gene2 <- "TOP2B"
d.cn_top5_drug %>%
  filter(gene_name == gene1 | gene_name == gene2) %>%
  ggplot(aes(x = log_copy_number, fill = gene_name)) +
  geom_histogram(binwidth = 0.1, color = "black", alpha = 0.75)+
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") + 
  facet_wrap(~gene_name)

d.expr_top5_drug %>%
  filter(gene_name == gene1 | gene_name == gene2) %>%
  ggplot(aes(x = rna_expression, fill = gene_name)) +
  geom_histogram(binwidth = 0.5, color = "black", alpha = 0.75)+
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") + 
  facet_wrap(~gene_name)

d.drug_gene1 <- d.drug_sens_filtered %>%
  filter(name == "etoposide")

d.drug_gene2 <- d.drug_sens_filtered %>%
  filter(name == "etoposide")

d.cn_gene1 <- d.cn_top5_drug %>%
  filter(gene_name == gene1) %>%
  group_by(gene_name) %>%
  mutate(bin_cn = ntile(log_copy_number, 4)) %>%
  mutate(bin_cn = factor(bin_cn, levels = c(4, 3, 2, 1))) %>%
  ungroup()

d.cn_gene2 <- d.cn_top5_drug %>%
  filter(gene_name == gene2) %>%
  group_by(gene_name) %>%
  mutate(bin_cn = ntile(log_copy_number, 4)) %>%
  mutate(bin_cn = factor(bin_cn, levels = c(4, 3, 2, 1))) %>%
  ungroup()

d.gene1_cn_gene2_drug <- left_join(d.cn_gene1, d.drug_gene2, by = "depmap_id") %>%
  filter(!is.na(compound))

d.gene2_cn_gene1_drug <- left_join(d.cn_gene2, d.drug_gene1, by = "depmap_id") %>%
  filter(!is.na(compound))

## TOP2A cn, TOP2B dependency
ggplot(d.gene2_cn_gene1_drug, aes(x = bin_cn, y = dependency, fill = bin_cn)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.gene2_cn_gene1_drug %>%
  filter(bin_cn %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_cn, alternative = "greater")$p.value)


d.gene2_cn_gene1_drug %>%
  filter(grepl("LUNG", cell_line.x)) %>%
  ggplot(aes(x = bin_cn, y = dependency, fill = bin_cn)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.gene2_cn_gene1_drug %>%
  filter(grepl("LUNG", cell_line.x)) %>%
  filter(bin_cn %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_cn, alternative = "greater")$p.value)

## TOP2B cn, TOP2A dependency
ggplot(d.gene1_cn_gene2_drug, aes(x = bin_cn, y = dependency, fill = bin_cn)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.gene1_cn_gene2_drug %>%
  filter(bin_cn %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_cn, alternative = "greater")$p.value)


d.gene1_cn_gene2_drug %>%
  filter(grepl("LUNG", cell_line.x)) %>%
  ggplot(aes(x = bin_cn, y = dependency, fill = bin_cn)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~name, scales = "free_y")

d.gene1_cn_gene2_drug %>%
  filter(grepl("LUNG", cell_line.x)) %>%
  filter(bin_cn %in% c(1, 4)) %>%
  group_by(name) %>%
  summarize("pval_1_v_4" = wilcox.test(dependency ~ bin_cn, alternative = "greater")$p.value)

d.gene1_cn_gene2_drug %>%
  group_by(bin_cn) %>%
  summarize("median_group_cn" = median(log_copy_number))

```

##### Secondary screen



#### CN vs. drug sensitivity
```{r}

## join tbls together

## get useful DepMap CN information
metadata
d.cn_top5_drug

d.tmp <- metadata %>%
  dplyr::select(depmap_id, stripped_cell_line_name, primary_disease,
                subtype_disease, lineage, lineage_subtype) %>%
  right_join(d.cn_top5_drug, by = "depmap_id") %>% # gets rid of cell lines with no CN data
  dplyr::select(-cell_line) %>%
  rename(cell_line = stripped_cell_line_name)
d.tmp

d.DeKegel_top5_druggable

## pivot DF longer so each gene in a pair is its own row
d.DeKegel_top5_druggable_genes <- d.DeKegel_top5_druggable %>%
  rename(A1_hgnc = A1, A2_hgnc = A2) %>%
  pivot_longer(cols = starts_with("A"),
               names_to = c("gene", ".value"),
               names_pattern = "A(.)_(.*)") %>%
  dplyr::select(prediction_rank:sorted_gene_pair,
                gene:drug_tier, 
                ensembl_pair:top_5_SL_all_screens)
d.DeKegel_top5_druggable_genes

## add cell line, CN information to top SL and druggable paralog pair df
d.DeKegel_top5_druggable_genes_depmap_cn <- d.DeKegel_top5_druggable_genes %>%
  right_join(d.tmp, by = c("entrez" = "entrez_id")) 
d.DeKegel_top5_druggable_genes_depmap_cn





```



```{r}

## make df to get A1 DepMap CN info
d.DeKegel_top5_druggable
d.tmp2 <- d.tmp %>%
  dplyr::select(-c(gene, gene_name))
d.tmp2

## make df to add A2 DepMap CN info
d.tmp3 <- d.tmp2 %>%
  dplyr::select(depmap_id, entrez_id, log_copy_number) %>%
  unite(depmap_entrez_id, c(depmap_id, entrez_id), sep = "_")
d.tmp3

## add cell line, CN info for each paralog to wide paralog DF
d.DeKegel_top5_druggable_depmap_cn <- d.DeKegel_top5_druggable %>%
  right_join(d.tmp2, by = c("A1_entrez" = "entrez_id")) %>%
  rename(A1_log_cn = log_copy_number) %>%
  unite(depmap_entrez_id, c(depmap_id, A2_entrez), sep = "_", remove = FALSE) %>% ## create new id column
  left_join(d.tmp3, by = "depmap_entrez_id") %>%
  rename(A2_log_cn = log_copy_number)
d.DeKegel_top5_druggable_depmap_cn

```

```{r}

drug_metadata
d.drug_sens_filtered

## expand df so each drug target is its own row
d.drug_sens_filtered_target <- d.drug_sens_filtered %>%
  separate_rows(target)
d.drug_sens_filtered_target

```


```{r}

### Adding CN info to top 5% of SL pairs from De Kegel paper
### Same as above 3 chunks but for all top 5% genes (no druggability filter)
# d.DeKegel_top5_druggable

d.DeKegel_top5 <- d.DeKegel %>%
  filter(prediction_percentile < 5)
d.DeKegel_top5

d.tmp <- metadata %>%
  ungroup() %>%
  dplyr::select(depmap_id, stripped_cell_line_name, primary_disease,
                subtype_disease, lineage, lineage_subtype) %>%
  right_join(d.cn_top5_drug, by = "depmap_id") %>% # gets rid of cell lines with no CN data
  dplyr::select(-c(cell_line, gene)) %>%
  rename(cell_line = stripped_cell_line_name)
d.tmp

d.DeKegel_top5_genes <- d.DeKegel_top5 %>%
  rename(A1_hgnc = A1, A2_hgnc = A2) %>%
  pivot_longer(cols = starts_with("A"),
               names_to = c("gene_pos", ".value"),
               names_pattern = "A(.)_(.*)") %>%
  dplyr::select(prediction_rank:sorted_gene_pair,
                gene_pos:ensembl,
                ensembl_pair:family_size)
d.DeKegel_top5_genes


## add cell line, CN information to top 5% predicted SL pair df
d.DeKegel_top5_genes_depmap_cn <- d.DeKegel_top5_genes %>%
  right_join(d.tmp, by = c("entrez" = "entrez_id")) %>%
  rename(log_cn = log_copy_number)
d.DeKegel_top5_genes_depmap_cn


d.DeKegel_top5_genes_depmap_cn <- d.DeKegel_top5_genes_depmap_cn %>%
  group_by(sorted_gene_pair, gene_name) %>%
  mutate(cn_bin = ntile(log_cn, n = 4)) %>%
  mutate(cn_bin = factor(cn_bin, levels = c(4, 3, 2, 1))) %>%
  ungroup()
d.DeKegel_top5_genes_depmap_cn


# d.DeKegel_top5_druggable_depmap_cn

## checking that it works
# d.DeKegel_top5_genes_depmap_cn %>%
#   filter(sorted_gene_pair == "HDAC1_HDAC2") %>%
#   filter(cell_line == "NIHOVCAR3")

## calculate CN ntiles


```

If I filter for the top 5th percentile of genes, I get 1,795 rows vs. 391 if we filter for Finan 2017 druggable *and* top 5th percentile. 


```{r}


## add DepMap drug sensitivity info

# drug_metadata
# d.drug_sens_filtered

## expand df so each drug target is its own row
d.drug_sens_filtered_target <- d.drug_sens_filtered %>%
  separate_rows(target) %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, name, dose, moa, target) %>%
  rename(compound_name = name)
d.drug_sens_filtered_target

d.DeKegel_top5_genes_depmap_cn_drug <- left_join(d.DeKegel_top5_genes_depmap_cn, 
                                                 d.drug_sens_filtered_target,
                                                 by = c("depmap_id" = "depmap_id", "gene_name" = "target"))
d.DeKegel_top5_genes_depmap_cn_drug


## CHECK THAT THIS ACTUALLY WORKED!!!!




# d.tmp1_A1 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene1, c(depmap_id, A1), sep = "_", remove = FALSE) 
# 
# d.tmp1_A2 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) 
#   
# d.tmp2 <- d.drug_sens_filtered_target %>%
#   # filter(target == "CDK19" | target == "CDK8") %>%
#   dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) %>%
#   unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
#   dplyr::select(-c(depmap_id, cell_line)) #%>%
#   # rename(compound_name = name)
# 
# d.DeKegel_top5_cn_drug_A1 <- left_join(d.tmp1_A1, d.tmp2, by = c("cell_line_gene1" = "cell_line_gene")) %>%
#   filter(!is.na(dependency)) %>%
#   unite(gene_pair_compound, c(sorted_gene_pair, compound), sep = "_", remove = FALSE) %>%
#   dplyr::select(-cell_line_gene1) %>%
#   ungroup() %>% ## lines below add labels for plotting
#   unite(tmp1, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
#   mutate(tmp2 = paste0("(", round(dose, digits = 2), " uM)")) %>%
#   unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
# d.DeKegel_top5_cn_drug_A1


## pivot wider
# d.DeKegel_top5_genes_depmap_cn %>%
#   pivot_wider(names_from = gene_pos,
#               names_glue = "A{gene_pos}_{.value}",
#               values_from = c(hgnc:ensembl, log_cn, gene_name))

## calculate combined CN, combined CN quartiles
## remove duplicate rows for drugs that target both paralogs

```



```{r}

## add drug info


```


```{r}

## calculate ntiles
# 
# d.DeKegel_top5_druggable_depmap_cn <-  d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   # unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) %>%
#   group_by(sorted_gene_pair) %>%
#   mutate(A1_cn_bin = ntile(A1_log_cn, n = 4),
#          A2_cn_bin = ntile(A2_log_cn, n = 4)) %>%
#   mutate(A1_cn_bin = factor(A1_cn_bin, levels = c(4, 3, 2, 1)),
#          A2_cn_bin = factor(A2_cn_bin, levels = c(4, 3, 2, 1))) %>%
#   dplyr::select(-c(prediction_score:top_5_percent))

```


```{r}

## combine DFs 
# 
# d.tmp1_A1 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene1, c(depmap_id, A1), sep = "_", remove = FALSE) 
# 
# d.tmp1_A2 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   # filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) 
#   
# d.tmp2 <- d.drug_sens_filtered_target %>%
#   # filter(target == "CDK19" | target == "CDK8") %>%
#   dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) %>%
#   unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
#   dplyr::select(-c(depmap_id, cell_line)) #%>%
#  # rename(compound_name = name)
# 
# d.DeKegel_top5_cn_drug_A1 <- left_join(d.tmp1_A1, d.tmp2, by = c("cell_line_gene1" = "cell_line_gene")) %>%
#   filter(!is.na(dependency)) %>%
#   unite(gene_pair_compound, c(sorted_gene_pair, compound), sep = "_", remove = FALSE) %>%
#   dplyr::select(-cell_line_gene1) %>%
#   ungroup() %>% ## lines below add labels for plotting
#   unite(tmp1, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
#   mutate(tmp2 = paste0("(", round(dose, digits = 2), " uM)")) %>%
#   unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
# d.DeKegel_top5_cn_drug_A1
# 
# d.DeKegel_top5_cn_drug_A2 <- left_join(d.tmp1_A2, d.tmp2, by = c("cell_line_gene2" = "cell_line_gene"))  %>%
#   filter(!is.na(dependency)) %>%
#   unite(gene_pair_compound, c(sorted_gene_pair, compound), sep = "_", remove = FALSE) %>%
#   dplyr::select(-cell_line_gene2) %>%
#   ungroup() %>% ## lines below add labels for plotting
#   unite(tmp1, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
#   mutate(tmp2 = paste0("(", round(dose, digits = 2), " uM)")) %>%
#   unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
# d.DeKegel_top5_cn_drug_A2



```







```{r}

# drug_metadata
# d.drug_sens_filtered
# 
# ## expand df so each drug target is its own row
# d.drug_sens_filtered_target <- d.drug_sens_filtered %>%
#   separate_rows(target)
# d.drug_sens_filtered_target

```

```{r}

## join drug data and CN/SL DFs

# d.DeKegel_top5_druggable_depmap_cn

## test case using CDK8/CDK19

# d.test1 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   filter(sorted_gene_pair == "CDK19_CDK8") %>%
#   unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) %>%
#   group_by(sorted_gene_pair) %>%
#   mutate(A1_cn_bin = ntile(A1_log_cn, n = 4),
#          A2_cn_bin = ntile(A2_log_cn, n = 4)) %>%
#   mutate(A1_cn_bin = factor(A1_cn_bin, levels = c(4, 3, 2, 1)),
#          A2_cn_bin = factor(A2_cn_bin, levels = c(4, 3, 2, 1)))
#   
# d.test2 <- d.drug_sens_filtered_target %>%
#   filter(target == "CDK19" | target == "CDK8") %>%
#   dplyr::select(depmap_id, cell_line, compound, dependency, name, dose, moa, target) %>%
#   unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
#   dplyr::select(-c(depmap_id, cell_line))
# 
# d.test <- left_join(d.test1, d.test2, by = c("cell_line_gene2" = "cell_line_gene"))
# d.test
# 
# d.test %>%
#   filter(!is.na(dependency)) %>%
#   ungroup() %>%
#   ggplot(aes(x = A1_cn_bin, y = dependency, fill = A1_cn_bin)) +
#   geom_boxplot() +
#   theme_bw() +
#   theme(aspect.ratio = 0.75,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap(~name, scales = "free_y")

```



```{r}

## test case using PAK1/PAK2

# d.test1 <- d.DeKegel_top5_druggable_depmap_cn %>%
#   filter(sorted_gene_pair == "PAK1_PAK2") %>%
#   unite(cell_line_gene1, c(depmap_id, A1), sep = "_", remove = FALSE) %>%
#   group_by(sorted_gene_pair) %>%
#   mutate(A1_cn_bin = ntile(A1_log_cn, n = 4),
#          A2_cn_bin = ntile(A2_log_cn, n = 4)) %>%
#   mutate(A1_cn_bin = factor(A1_cn_bin, levels = c(4, 3, 2, 1)),
#          A2_cn_bin = factor(A2_cn_bin, levels = c(4, 3, 2, 1)))
#   
# d.test2 <- d.drug_sens_filtered_target %>%
#   filter(target == "PAK1" | target == "PAK2") %>%
#   dplyr::select(depmap_id, cell_line, compound, dependency, name, moa, target) %>%
#   unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
#   dplyr::select(-c(depmap_id, cell_line))
# 
# d.test <- left_join(d.test1, d.test2, by = c("cell_line_gene1" = "cell_line_gene"))
# d.test
# 
# d.test %>%
#   filter(!is.na(dependency)) %>%
#   ungroup() %>%
#   ggplot(aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
#   geom_boxplot() +
#   theme_bw() +
#   theme(aspect.ratio = 0.75,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap(~name, scales = "free_y")
# 
# d.test %>%
#   filter(A2_cn_bin %in% c(1, 4)) %>%
#   summarize("pval" = wilcox.test(dependency ~ A2_cn_bin, alternative = "greater")$p.value)
  
```
##### Make DFs
```{r}

## calculate ntiles

d.DeKegel_top5_druggable_depmap_cn <-  d.DeKegel_top5_druggable_depmap_cn %>%
  # filter(sorted_gene_pair == "CDK19_CDK8") %>%
  # unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) %>%
  group_by(sorted_gene_pair) %>%
  mutate(A1_cn_bin = ntile(A1_log_cn, n = 4),
         A2_cn_bin = ntile(A2_log_cn, n = 4)) %>%
  mutate(A1_cn_bin = factor(A1_cn_bin, levels = c(4, 3, 2, 1)),
         A2_cn_bin = factor(A2_cn_bin, levels = c(4, 3, 2, 1))) %>%
  dplyr::select(-c(prediction_score:top_5_percent))

```


```{r}

## combine DFs 

d.tmp1_A1 <- d.DeKegel_top5_druggable_depmap_cn %>%
  # filter(sorted_gene_pair == "CDK19_CDK8") %>%
  unite(cell_line_gene1, c(depmap_id, A1), sep = "_", remove = FALSE) 

d.tmp1_A2 <- d.DeKegel_top5_druggable_depmap_cn %>%
  # filter(sorted_gene_pair == "CDK19_CDK8") %>%
  unite(cell_line_gene2, c(depmap_id, A2), sep = "_", remove = FALSE) 
  
d.tmp2 <- d.drug_sens_filtered_target %>%
  # filter(target == "CDK19" | target == "CDK8") %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) %>%
  unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
  dplyr::select(-c(depmap_id, cell_line)) #%>%
  # rename(compound_name = name)

d.DeKegel_top5_cn_drug_A1 <- left_join(d.tmp1_A1, d.tmp2, by = c("cell_line_gene1" = "cell_line_gene")) %>%
  filter(!is.na(dependency)) %>%
  unite(gene_pair_compound, c(sorted_gene_pair, compound), sep = "_", remove = FALSE) %>%
  dplyr::select(-cell_line_gene1) %>%
  ungroup() %>% ## lines below add labels for plotting
  unite(tmp1, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate(tmp2 = paste0("(", round(dose, digits = 2), " uM)")) %>%
  unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
d.DeKegel_top5_cn_drug_A1

d.DeKegel_top5_cn_drug_A2 <- left_join(d.tmp1_A2, d.tmp2, by = c("cell_line_gene2" = "cell_line_gene"))  %>%
  filter(!is.na(dependency)) %>%
  unite(gene_pair_compound, c(sorted_gene_pair, compound), sep = "_", remove = FALSE) %>%
  dplyr::select(-cell_line_gene2) %>%
  ungroup() %>% ## lines below add labels for plotting
  unite(tmp1, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate(tmp2 = paste0("(", round(dose, digits = 2), " uM)")) %>%
  unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
d.DeKegel_top5_cn_drug_A2

```


##### WRST
```{r}

d.DeKegel_top5_cn_drug_A1 %>%
  filter(sorted_gene_pair == "ABCB6_ABCB7") %>%
  filter(A2_cn_bin %in% c(1, 4)) %>%
  group_by(A2_cn_bin) 

d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_summary <- d.DeKegel_top5_cn_drug_A1 %>%
  filter(A2_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ A2_cn_bin, alternative = "greater")$p.value) 
d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_summary

d.DeKegel_top5_cn_drug_A1_pval <- left_join(d.DeKegel_top5_cn_drug_A1, d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_summary, 
                                            by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_cn_drug_A1_pval

```

###### Test plot
```{r}

d.DeKegel_top5_cn_drug_A1_pval

d.DeKegel_top5_cn_drug_A1_pval %>%
  filter(pval < 0.05) %>%
  group_by(sorted_gene_pair, compound_name) %>%
  summarize(n = n())

d.DeKegel_top5_cn_drug_A1_pval %>%
  filter(pval < 0.05)

d.DeKegel_top5_cn_drug_A1_pval %>%
  filter(pval < 0.05) %>%
  filter(sorted_gene_pair == "ABCB1_ABCB4") %>%
  distinct(compound, .keep_all = TRUE)


```


```{r}

## plot all drugs for one pair
d.DeKegel_top5_cn_drug_A1_pval %>%
  filter(sorted_gene_pair == "ABCB1_ABCB4") %>%
  # filter(pval < 0.05) %>%
  ggplot(aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
  geom_boxplot() +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~sorted_gene_pair+compound_name, scales = "free_y")


## plot only significant drugs for one pair
d.DeKegel_top5_cn_drug_A1_pval %>%
  filter(sorted_gene_pair == "ABCB1_ABCB4") %>%
  filter(pval < 0.05) %>%
  ggplot(aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
  geom_boxplot() +
  geom_signif(comparisons = list(c(1, 4)),
              map_signif_level = FALSE,
              test = "wilcox.test",
              test.args = list(alternative = "greater"),
              textsize = 3.2) +
  scale_y_continuous(expand = expansion(mult = 0.1)) +
  scale_fill_brewer(palette = "YlGnBu", direction = -1) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none") +
  facet_wrap(~sorted_gene_pair+compound_name, scales = "free_y")

```

###### All plots


```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_cn_drug_A1_pval <- d.DeKegel_top5_cn_drug_A1_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_cn_drug_A1_pval_signif <- d.DeKegel_top5_cn_drug_A1_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_cn_drug_A1_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_A2_cn_vs_A1_drug_pval_signif_fixed_noFinan.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_cn_drug_A1_pval_signif,
#                aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

# d.DeKegel_top5_cn_drug_A1_pval_signif

```

I am currently getting the following error for facet_wrap_paginate: `Error: Cannot create zero-length unit vector ("unit" subsetting)`. This seems to be an R v4.0 error, and I'm not sure how to fix it. So as a workaround, I've plotted the remaining plots as a separate file. 
^ I believe I fixed this error by changing the compound/dose labels. It's no longer happening. 



```{r}

## calculate p-vals for drugs targeting A2 vs. A1 CN
# d.DeKegel_top5_cn_drug_A2

d.DeKegel_top5_cn_drug_A2_vs_cn_A1_pval_summary <- d.DeKegel_top5_cn_drug_A2 %>%
  filter(A1_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ A1_cn_bin, alternative = "greater")$p.value) 
# d.DeKegel_top5_cn_drug_A2_vs_cn_A1_pval_summary

d.DeKegel_top5_cn_drug_A2_pval <- left_join(d.DeKegel_top5_cn_drug_A2, 
                                            d.DeKegel_top5_cn_drug_A2_vs_cn_A1_pval_summary, 
                                            by = c("sorted_gene_pair", "compound"))
# d.DeKegel_top5_cn_drug_A2_pval

## plot all pairs, sorted by p-value
d.DeKegel_top5_cn_drug_A2_pval <- d.DeKegel_top5_cn_drug_A2_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_cn_drug_A2_pval_signif <- d.DeKegel_top5_cn_drug_A2_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_cn_drug_A2_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_A1_cn_vs_A2_drug_pval_signif_fixed.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_cn_drug_A2_pval_signif,
#                aes(x = A1_cn_bin, y = dependency, fill = A1_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()


```

```{r}

d.DeKegel_top5_cn_drug_A2_pval_signif %>%
  filter(sorted_gene_pair == "AURKA_AURKB" | sorted_gene_pair == "AURKA_AURKC") %>%
  filter(compound_name == "danusertib") %>%
  distinct(gene_pair_compound, .keep_all = TRUE)

d.DeKegel_top5_cn_drug_A2_pval_signif %>%
  filter(sorted_gene_pair == "SRPK1_SRPK2") %>%
  filter(compound_name == "SRPIN340") %>%
  distinct(gene_pair_compound, .keep_all = TRUE)

```
There is an issue when one compound is tested at >1 dose. See: AURKA_AURKC and AURKA_AURKB with danusertib. The p-values calculated outside geom_signif() are correct, but the geom_signif() is messed up because facet_wrap_paginate is based on the compound name rather than the compound ID (which contains dose information). Maybe I should try to combine the compound name with the dose. 

^Fixed!

##### K-S test

```{r}

## calculate p-vals for drugs targeting A2 vs. A1 CN
# d.DeKegel_top5_cn_drug_A2

d.DeKegel_top5_cn_drug_A1_vs_cn_A2_ks_pval_summary <- d.DeKegel_top5_cn_drug_A1 %>%
  filter(!is.na(A2_cn_bin)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = kruskal.test(dependency ~ A2_cn_bin)$p.value)
d.DeKegel_top5_cn_drug_A1_vs_cn_A2_ks_pval_summary

d.DeKegel_top5_cn_drug_A1_ks_pval <- left_join(d.DeKegel_top5_cn_drug_A1,
                                                d.DeKegel_top5_cn_drug_A1_vs_cn_A2_ks_pval_summary, 
                                                by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_cn_drug_A1_ks_pval

## plot all pairs, sorted by p-value
d.DeKegel_top5_cn_drug_A1_ks_pval <- d.DeKegel_top5_cn_drug_A1_ks_pval %>%
  ungroup() %>%
  unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

# d.DeKegel_top5_cn_drug_A1_ks_pval_signif_sens <- d.DeKegel_top5_cn_drug_A1_ks_pval %>%
#   filter(pval < 0.05) %>%
#   group_by(gene_pair_compound, A2_cn_bin) %>%
#   mutate(median_dependency = median(dependency)) %>%
  
# d.DeKegel_top5_cn_drug_A1_ks_pval_signif_sens

# length <- d.DeKegel_top5_cn_drug_A1_ks_pval_signif %>%
#   ungroup() %>%
#   distinct(gene_pair_compound_label) %>%
#   nrow()

n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_A2_cn_vs_A1_drug_ks_pval_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_cn_drug_A1_ks_pval_signif,
#                aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 2, 3, 4)),
#               map_signif_level = FALSE,
#               test = "kruskal.test",
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()


```


I couldn't figure out how to do a K-S test in geom_signif() so I used stat_compare_means() instead, per this site: https://www.r-bloggers.com/2017/06/add-p-values-and-significance-levels-to-ggplots/

```{r}

# d.DeKegel_top5_cn_drug_A1_ks_pval_signif %>%
#   filter(gene_pair_compound == "HDAC1_HDAC2_BRD-K13169950-001-14-4::2.5::HTS" | 
#            gene_pair_compound == "HDAC1_HDAC2_BRD-K88742110-001-07-9::2.5::HTS") %>%
#   ggplot(aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
#   geom_boxplot() +
#   stat_compare_means(size = 3.25) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap(~gene_pair_compound_label, scales = "free_y",
#              nrow = 3, ncol = 3)
# 
# d.DeKegel_top5_cn_drug_A1_ks_pval_signif %>%
#   filter(gene_pair_compound == "HDAC1_HDAC2_BRD-K13169950-001-14-4::2.5::HTS" | 
#            gene_pair_compound == "HDAC1_HDAC2_BRD-K88742110-001-07-9::2.5::HTS") %>%
#   group_by(gene_pair_compound, A2_cn_bin) %>%
#   mutate(group_median = median(dependency)) %>%
#   arrange(gene_pair_compound, A2_cn_bin)
# 
# d.DeKegel_top5_cn_drug_A1_ks_pval_signif %>%
#   filter(gene_pair_compound == "HDAC1_HDAC2_BRD-K13169950-001-14-4::2.5::HTS" |
#            gene_pair_compound == "HDAC1_HDAC2_BRD-K88742110-001-07-9::2.5::HTS") %>%
#   group_by(gene_pair_compound, A2_cn_bin) %>%
#   summarize(med_dep = median(dependency))

```

#### Combined CN vs. drug sensitivity
```{r}

# drugs that target A1 or A2 (or both?)

```


##### Make DF
```{r}

## calculate ntiles for combined CN
## updated to fix combined CN calcs 12/3

d.DeKegel_top5_druggable_depmap_combined_cn <- d.DeKegel_top5_druggable_depmap_cn %>%
  mutate(combined_log_cn = log2((2^A1_log_cn) + (2^A2_log_cn))) %>%
  group_by(sorted_gene_pair) %>%
  mutate(combined_cn_bin = ntile(combined_log_cn, n = 4)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 2, 3, 4)))

```

```{r}

## add paralog pair information to drug DF
d.drugs <- d.drug_sens_filtered_target %>%
  # filter(target == "CDK19" | target == "CDK8") %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) #%>%
  # unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
  # dplyr::select(-c(depmap_id, cell_line)) %>%
  # rename(compound_name = name)

d.pairs <- d.DeKegel_top5_druggable_depmap_combined_cn %>%
  dplyr::select(sorted_gene_pair, A1, A2) %>%
  distinct(sorted_gene_pair, .keep_all = TRUE) %>%
  pivot_longer(cols = A1:A2, names_to = "pos", values_to = "gene_name")

d.pairs
d.drugs

## use inner_join to get rid of paralog pairs w/o a drug that targets them
d.drug_pairs <- inner_join(d.pairs, d.drugs, by = c("gene_name" = "target"))
d.drug_pairs

## check for drugs that target both members of a pair
d.drug_pairs %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1)

d.drug_pairs %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n == 1)

## get list of double-targeting gene pair and compound names
double_targeting_drugs <- d.drug_pairs %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1) %>%
  unite("double_targeting_compounds", c("sorted_gene_pair", "compound")) %>%
  distinct(double_targeting_compounds) %>%
  pull()

## how many double-targetings will be removed?
d.drug_pairs %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  group_by(rm_flag) %>%
  summarize(n = n())

# around 383214 - this makes sense b/c 663 double-targeting drug/pair combos * ~500 cell lines
# is roughly 300k rows

## remove the double-targetings
d.drug_pairs <- d.drug_pairs %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  filter(rm_flag == FALSE) %>%
  dplyr::select(-c("gene_pair_compound", "rm_flag"))

```


```{r}

## combine DFs 
d.DeKegel_top5_druggable_depmap_combined_cn
d.drug_pairs

d.DeKegel_top5_combined_cn_drug_pair <- left_join(d.DeKegel_top5_druggable_depmap_combined_cn, 
                                                  d.drug_pairs, 
                                                  by = c("depmap_id", "sorted_gene_pair")) %>%
  filter(!is.na(dependency)) %>%
  ungroup() %>%
  unite("tmp1", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("tmp2" = paste0("(", round(dose, digits = 2), " uM)")) %>%
  unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
d.DeKegel_top5_combined_cn_drug_pair

```






##### WRST
```{r}

d.DeKegel_top5_combined_cn_drug_pair_pval_summary <- d.DeKegel_top5_combined_cn_drug_pair %>%
  filter(combined_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ combined_cn_bin, alternative = "less")$p.value) 
d.DeKegel_top5_combined_cn_drug_pair_pval_summary

d.DeKegel_top5_combined_cn_drug_pair_pval <- left_join(d.DeKegel_top5_combined_cn_drug_pair,
                                                       d.DeKegel_top5_combined_cn_drug_pair_pval_summary, 
                                            by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_combined_cn_drug_pair_pval

```

```{r}

pvals <- d.DeKegel_top5_combined_cn_drug_pair_pval %>%
  distinct(sorted_gene_pair, compound, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(pval) %>%
  pull()

fdr_vals <- p.adjust(pvals, method = "BH")
head(fdr_vals)

d.fdr_vals <- tibble(fdr = fdr_vals)

d.fdr_vals %>%
  filter(fdr < 0.05) %>%
  nrow()

d.fdr_vals %>%
  filter(fdr < 0.1) %>%
  nrow()

```

##### Add FDR-adjusted p-values to DF
```{r}

d.pvals_labels <- d.DeKegel_top5_combined_cn_drug_pair_pval %>%
  distinct(sorted_gene_pair, compound, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(sorted_gene_pair, compound) 
d.pvals_labels

d.fdr_vals

d.fdr_vals_labeled <- d.pvals_labels %>%
  add_column(d.fdr_vals)
d.fdr_vals_labeled

d.DeKegel_top5_combined_cn_drug_pair <- d.DeKegel_top5_combined_cn_drug_pair %>%
  left_join(d.fdr_vals_labeled, by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_combined_cn_drug_pair

## filtered DF with just FDR < 0.1
d.DeKegel_top5_combined_cn_drug_pair_fdr_signif <- d.DeKegel_top5_combined_cn_drug_pair %>%
  filter(fdr < 0.1)

nrow(d.DeKegel_top5_combined_cn_drug_pair_fdr_signif)
d.DeKegel_top5_combined_cn_drug_pair_fdr_signif

```
The number of rows matches what I calculated above. 


##### Plot

* check how many were significant before I got rid of the Finan step
* print only statistically significant interactions (Bonferroni-corrected)
* print stat sig + CN

###### All pvals

```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_combined_cn_drug_pair_pval <- d.DeKegel_top5_combined_cn_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_combined_cn_drug_pair_pval_signif <- d.DeKegel_top5_combined_cn_drug_pair_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_combined_cn_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_cn_vs_drug_sens_WRST_pval_signif_noFinan.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_cn_drug_pair_pval_signif,
#                aes(x = combined_cn_bin, y = dependency, fill = combined_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

# d.DeKegel_top5_cn_drug_A1_pval_signif

```
Possibly an error here (the usual `Error: Cannot create zero-length unit vector ("unit" subsetting)`) â€” investigate!!


###### Top pvals

```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_combined_cn_drug_pair_pval <- d.DeKegel_top5_combined_cn_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_combined_cn_drug_pair_pval_signif <- d.DeKegel_top5_combined_cn_drug_pair_pval %>% 
  filter(pval <= 0.05)

length <- d.DeKegel_top5_combined_cn_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_cn_vs_drug_sens_WRST_pval_L0.05_plus_cn_update3_noFinan.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_cn_drug_pair_pval_signif,
#                aes(x = combined_cn_bin, y = dependency, fill = combined_cn_bin)) +
#     geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_combined_cn_drug_pair_pval_signif,
#                aes(x = combined_cn_bin, y = combined_log_cn, fill = combined_cn_bin)) +
#     geom_hline(yintercept = 2) +
#     geom_hline(yintercept = log2(3), linetype = "dashed") +
#     geom_hline(yintercept = log2(5), linetype = "dashed") +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "Combined_log_CN") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```


###### FDR signif

Plotting FDR values from DF directly onto ggsignif(): 
https://github.com/const-ae/ggsignif/issues/29
https://cran.r-project.org/web/packages/ggsignif/ggsignif.pdf

```{r}

## plot all FDR < 0.1 pairs (sorted by FDR)
## add my own labels!!

d.DeKegel_top5_combined_cn_drug_pair_fdr_signif <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, fdr),
         "sorted_gene_pair" = reorder(sorted_gene_pair, fdr)) #%>%
  # mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 2, 3, 4)))

length <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()

d.fdr_labels <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  ungroup() %>%
  dplyr::select(gene_pair_compound_label, combined_cn_bin, fdr)
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_cn_vs_drug_sens_WRST_fdr_signif_plus_cn_update3_noFinan.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_cn_drug_pair_fdr_signif,
#                aes(x = combined_cn_bin, y = dependency, fill = combined_cn_bin)) +
#     geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less", p.adjust.method = "BH"),
#               # annotations = fdr_labels, # fix this to get FDR plotted direclty
#               textsize = 3.2) +
#   # add_pvalue(d.fdr_labels) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_CN_bin",
#          y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_combined_cn_drug_pair_fdr_signif,
#                aes(x = combined_cn_bin, y = (2^combined_log_cn), fill = combined_cn_bin)) +
#     geom_hline(yintercept = 4) +
#     geom_hline(yintercept = 3, linetype = "dashed") +
#     geom_hline(yintercept = 5, linetype = "dashed") +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_CN_bin",
#          y = "Combined_CN") +
#   coord_trans(y = "log2") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```

```{r}

## calculate difference in mean/median dependency between Q1 and Q4 
## log2 fold change or not???
## make volcano plot of that vs. FDR
d.DeKegel_top5_combined_cn_drug_pair 

d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr <- d.DeKegel_top5_combined_cn_drug_pair %>%
  filter(combined_cn_bin == 1 | combined_cn_bin == 4) %>% # get only bins 1 & 4; update to min & max
  group_by(sorted_gene_pair, compound, combined_cn_bin) %>%
  mutate(median_dependency = median(dependency)) %>%
  dplyr::select(prediction_rank:top_5_SL_all_screens, combined_cn_bin, compound, 
                compound_name:moa, median_dependency, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound, combined_cn_bin)), .keep_all = TRUE) %>%
  ungroup()
d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr

d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr%>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n())
  # pivot_wider(names_from = combined_cn_bin,
  #             names_glue = "Q{combined_cn_bin}_{.value}",
  #             values_from = dependency)
  # group_by(sorted_gene_pair, compound) %>%
  # summarize()

d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr_wide <- d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr %>%
  # group_by(sorted_gene_pair, compound) %>%
  pivot_wider(id_cols = c(sorted_gene_pair, compound, gene_pair_compound_label,
                          compound_name, moa, fdr), 
              names_from = combined_cn_bin, 
              names_glue = "Q{combined_cn_bin}_{.value}",
              values_from = median_dependency) %>%
  mutate(lfc_dependency_Q1_v_Q4 = Q1_median_dependency - Q4_median_dependency)
d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr_wide

```

```{r}

d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr_wide %>%
  filter(fdr < 0.1)

d.phase1_cn_volcano_plot <- d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr_wide %>%
  filter(lfc_dependency_Q1_v_Q4 < 0) %>%
  unite(c(sorted_gene_pair, compound_name), col = new_label, sep = "\n", remove = FALSE)

phase1_cn_labels <- d.phase1_cn_volcano_plot %>%
  filter(fdr < 0.1) %>%
  pull(new_label)

ggplot(d.phase1_cn_volcano_plot, aes(x = lfc_dependency_Q1_v_Q4, y = -log10(fdr))) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(color = ifelse(d.phase1_cn_volcano_plot$fdr < 0.1, "black", "gray50")) +
  geom_label_repel(data = subset(d.phase1_cn_volcano_plot, fdr < 0.1),
                   aes(label = phase1_cn_labels), 
                   segment.size = 0.2,
                   force = 0.5,
                   size = 2.5, 
                   alpha = 0.8, 
                   max.overlaps = Inf) +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "d.DeKegel_top5_combined_cn_drug_pair_median_dependency_lfc_fdr_volcano_plot.pdf"),
#        width = 6, height = 4, useDingbats = FALSE)

```

useful geom_text_repel and geom_label_repel examples: https://ggrepel.slowkow.com/articles/examples.html

##### Phase 2 for validation

###### Make DF
```{r}

## combine DFs 
# d.DeKegel_top5_druggable_depmap_combined_cn
# d.drug_pairs

## select FDR < 0.1 only, remove ::, get unique gene pair/compound info => pull out of secondary screen
# d.DeKegel_top5_combined_cn_drug_pair
# d.Broad_secondary_auc
# 
# d.DeKegel_top5_combined_cn_drug_pair_fdr_signif 

```


```{r}

d.combined_cn_FDR_signif <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  distinct(across(c(sorted_gene_pair, compound)))
d.combined_cn_FDR_signif

combined_cn_FDR_signif_drugs <- d.combined_cn_FDR_signif %>%
  # dplyr::select(compound) %>%
  separate(col = compound, into = c("id", "dose", "other"), sep = "::") %>%
  dplyr::select(sorted_gene_pair, id) %>%
  distinct() %>%
  pull(id)
combined_cn_FDR_signif_drugs

## get relevant columns from AUC df
d.tmp2 <- d.Broad_secondary_auc %>%
  dplyr::select(broad_id, depmap_id, auc) %>%
  rename(compound_id = broad_id)
d.tmp2

## combine with CN df
d.tmp1 <- d.DeKegel_top5_combined_cn_drug_pair %>%
  dplyr::select(prediction_rank, prediction_percentile, sorted_gene_pair:gene_name,
                compound, compound_name, moa) %>%
  separate(col = compound, into = c("compound_id", "dose", "other"), sep = "::") %>%
  dplyr::select(-c(dose, other)) %>%
  distinct(across(c(depmap_id, sorted_gene_pair, compound_id)), .keep_all = TRUE)
d.tmp1
## 1,173,337 rows => 1,173,337 rows ??

## join CN info with secondary AUC data

# d.tmp1
# d.tmp2

d.DeKegel_top5_depmap_combined_cn_phase2_drug <- right_join(d.tmp1, d.tmp2, by = c("depmap_id", "compound_id")) %>%
  filter(!is.na(auc)) %>%
  ungroup() %>%
  unite("gene_pair_compound_label", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE)
d.DeKegel_top5_depmap_combined_cn_phase2_drug

```



```{r}

## WRST => add p-val to DF
d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_summary <- d.DeKegel_top5_depmap_combined_cn_phase2_drug %>%
  filter(combined_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound_id) %>%
  summarize("pval" = wilcox.test(auc ~ combined_cn_bin, alternative = "less")$p.value)
d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_summary

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval <- left_join(d.DeKegel_top5_depmap_combined_cn_phase2_drug, 
                                                                d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_summary, 
                                                                by = c("sorted_gene_pair", "compound_id"))
d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval

```

```{r}

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval %>%
  distinct(gene_pair_compound_label, .keep_all = TRUE) %>%
  arrange(pval)

d.drug_pair_fdr_signif_phase1 <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  separate(col = compound, into = c("compound_id", "dose", "other"), sep = "::") %>%
  dplyr::select(-c(dose, other)) %>%
  distinct(across(c(sorted_gene_pair, compound_id)))
d.drug_pair_fdr_signif_phase1

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 <- semi_join(d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval, d.drug_pair_fdr_signif_phase1,
          by = c("sorted_gene_pair", "compound_id"))

```

```{r}

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1


pvals <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
  distinct(sorted_gene_pair, compound_id, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(pval) %>%
  pull()

fdr_vals <- p.adjust(pvals, method = "BH")
head(fdr_vals)

d.fdr_vals <- tibble(fdr = fdr_vals)

d.fdr_vals %>%
  filter(fdr < 0.05) %>%
  nrow()

d.fdr_vals %>%
  filter(fdr < 0.1) %>%
  nrow()

d.pvals_labels <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
  distinct(sorted_gene_pair, compound_id, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(sorted_gene_pair, compound_id) 
d.pvals_labels

d.fdr_vals

d.fdr_vals_labeled <- d.pvals_labels %>%
  add_column(d.fdr_vals)
d.fdr_vals_labeled

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
  left_join(d.fdr_vals_labeled, by = c("sorted_gene_pair", "compound_id"))
d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1

## filtered DF with just FDR < 0.1
# d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1_fdr_signif_phase2 <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
#   filter(fdr < 0.1)

# nrow(d.DeKegel_top5_combined_cn_drug_pair_fdr_signif)
# d.DeKegel_top5_combined_cn_drug_pair_fdr_signif

```


###### Plot

```{r}

## plot all FDR < 0.1 pairs (sorted by FDR)
## add my own labels!!

d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval)) #%>%
  # mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 2, 3, 4)))

length <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()

# d.fdr_labels <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
#   ungroup() %>%
#   dplyr::select(gene_pair_compound_label, combined_cn_bin, fdr)
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1,
#                aes(x = combined_cn_bin, y = auc, fill = combined_cn_bin)) +
#     # geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less", p.adjust.method = "BH"),
#               # annotations = fdr_labels, # fix this to get FDR plotted direclty
#               textsize = 3.2) +
#   # add_pvalue(d.fdr_labels) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_CN_bin",
#          y = "Dose_response_AUC") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1,
#                aes(x = combined_cn_bin, y = (2^combined_log_cn), fill = combined_cn_bin)) +
#     geom_hline(yintercept = 4) +
#     geom_hline(yintercept = 3, linetype = "dashed") +
#     geom_hline(yintercept = 5, linetype = "dashed") +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_CN_bin",
#          y = "Combined_CN") +
#   coord_trans(y = "log2") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```


```{r}

## get FDR from phase 1, p-val from Phase 2 (adjust for 20 tests?)
# d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%

## adjust p-vals
d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1
d.tmp1 <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
  dplyr::select(gene_pair_compound_label, sorted_gene_pair, compound_id, compound_name, moa, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound_id)), .keep_all = TRUE) %>%
  rename(phase2_fdr = fdr)
d.tmp1

## plot scatterplot of drug/gene pair FDR correlation
d.DeKegel_top5_combined_cn_drug_pair_fdr_signif
d.tmp2 <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  separate(col = compound, into = c("compound_id", "dose_rm", "null"), sep = "::") %>%
  dplyr::select(-c(dose_rm, null)) %>%
  dplyr::select(sorted_gene_pair, compound_id, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound_id)), .keep_all = TRUE) %>%
  rename(phase1_fdr = fdr)
d.tmp2

d.combined_cn_phase1_fdr_signif_v_phase2_fdr <- left_join(d.tmp1, d.tmp2, 
                                                          by = c("sorted_gene_pair", "compound_id"))
d.combined_cn_phase1_fdr_signif_v_phase2_fdr

```


```{r}

d.combined_cn_phase1_fdr_signif_v_phase2_fdr
d.combined_cn_phase1_fdr_signif_v_phase2_fdr %>%
  filter(phase2_fdr < 0.1)

# d.phase1_cn_volcano_plot <- d.DeKegel_top5_combined_cn_drug_pair_median_dependency_fdr_wide %>%
#   filter(lfc_dependency_Q1_v_Q4 < 0) %>%
#   unite(c(sorted_gene_pair, compound_name), col = new_label, sep = "\n", remove = FALSE)

phase1_v_phase2_cn_fdr_labels <- d.combined_cn_phase1_fdr_signif_v_phase2_fdr %>%
  pull(gene_pair_compound_label)

ggplot(d.combined_cn_phase1_fdr_signif_v_phase2_fdr, aes(x = -log10(phase1_fdr), y = -log10(phase2_fdr))) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  # geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(color = ifelse(d.combined_cn_phase1_fdr_signif_v_phase2_fdr$phase2_fdr < 0.1, "black", "gray50")) +
  geom_label_repel(data = d.combined_cn_phase1_fdr_signif_v_phase2_fdr,
                   aes(label = gene_pair_compound_label), 
                   segment.size = 0.2,
                   force = 1,
                   nudge_x = 0.5,
                   nudge_y = 0.5,
                   size = 2.5, 
                   alpha = 0.8, 
                   max.overlaps = Inf) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "d.DeKegel_top5_combined_cn_drug_pair_phase1_fdr_v_phase2_fdr.pdf"),
#        width = 4.5, height = 4.5, useDingbats = FALSE)


```



#### Lung only (comb. CN)
```{r}

## calculate ntiles for combined CN

d.DeKegel_top5_druggable_depmap_cn

d.DeKegel_top5_druggable_depmap_cn %>%
  filter(lineage == "lung")

d.DeKegel_top5_druggable_depmap_lung_combined_cn <- d.DeKegel_top5_druggable_depmap_cn %>%
  filter(lineage == "lung") %>%
  mutate(combined_log_cn = A1_log_cn + A2_log_cn) %>%
  group_by(sorted_gene_pair) %>%
  mutate(combined_cn_bin = ntile(combined_log_cn, n = 4)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(4, 3, 2, 1)))

```

```{r}

## add paralog pair information to drug DF
d.drugs <- d.drug_sens_filtered_target %>%
  # filter(target == "CDK19" | target == "CDK8") %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) #%>%
  # unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
  # dplyr::select(-c(depmap_id, cell_line)) %>%
  #rename(compound_name = name)

d.pairs_lung <- d.DeKegel_top5_druggable_depmap_lung_combined_cn %>%
  dplyr::select(sorted_gene_pair, A1, A2) %>%
  distinct(sorted_gene_pair, .keep_all = TRUE) %>%
  pivot_longer(cols = A1:A2, names_to = "pos", values_to = "gene_name")

## use inner_join to get rid of paralog pairs w/o a drug that targets them
d.drug_pairs_lung <- inner_join(d.pairs_lung, d.drugs, by = c("gene_name" = "target"))
d.drug_pairs_lung

## check for drugs that target both members of a pair
d.drug_pairs_lung %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1)

## get list of double-targeting gene pair and compound names
double_targeting_drugs <- d.drug_pairs_lung %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1) %>%
  unite("double_targeting_compounds", c("sorted_gene_pair", "compound")) %>%
  distinct(double_targeting_compounds) %>%
  pull()

## how many double-targetings will be removed?
d.drug_pairs_lung %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  group_by(rm_flag) %>%
  summarize(n = n())

# around 383214 - this makes sense b/c 663 double-targeting drug/pair combos * ~500 cell lines
# is roughly 300k rows

## remove the double-targetings
d.drug_pairs_lung <- d.drug_pairs_lung %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  filter(rm_flag == FALSE) %>%
  dplyr::select(-c("gene_pair_compound", "rm_flag"))

```


```{r}

## combine DFs 
# d.DeKegel_top5_druggable_depmap_combined_cn
# d.drug_pairs

d.DeKegel_top5_lung_combined_cn_drug_pair <- left_join(d.DeKegel_top5_druggable_depmap_lung_combined_cn, 
                                                       d.drug_pairs_lung, 
                                                       by = c("depmap_id", "sorted_gene_pair")) %>%
  filter(!is.na(dependency)) %>%
  ungroup() %>%
  unite("tmp1", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("tmp2" = paste0("(", round(dose, digits = 2), " uM)")) %>%
  unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
d.DeKegel_top5_lung_combined_cn_drug_pair

```


##### WRST
```{r}

d.DeKegel_top5_lung_combined_cn_drug_pair_pval_summary <- d.DeKegel_top5_lung_combined_cn_drug_pair %>%
  filter(combined_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ combined_cn_bin, alternative = "greater")$p.value) 
d.DeKegel_top5_lung_combined_cn_drug_pair_pval_summary

d.DeKegel_top5_lung_combined_cn_drug_pair_pval <- left_join(d.DeKegel_top5_lung_combined_cn_drug_pair,
                                                            d.DeKegel_top5_lung_combined_cn_drug_pair_pval_summary, 
                                                            by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_lung_combined_cn_drug_pair_pval

```

##### Plot
```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_lung_combined_cn_drug_pair_pval <- d.DeKegel_top5_lung_combined_cn_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_lung_combined_cn_drug_pair_pval_signif <- d.DeKegel_top5_lung_combined_cn_drug_pair_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_lung_combined_cn_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_lung_combined_cn_vs_drug_sens_WRST_pval_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_cn_drug_pair_pval_signif,
#                aes(x = combined_cn_bin, y = dependency, fill = combined_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

# d.DeKegel_top5_cn_drug_A1_pval_signif

```

#### CN vs. drug resistance
```{r}

d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_resist_summary <- d.DeKegel_top5_cn_drug_A1 %>%
  filter(A2_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ A2_cn_bin, alternative = "less")$p.value) 
d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_resist_summary %>%
  arrange(pval)

d.DeKegel_top5_cn_drug_A1_pval_resist <- left_join(d.DeKegel_top5_cn_drug_A1, d.DeKegel_top5_cn_drug_A1_vs_cn_A2_pval_resist_summary, 
                                            by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_cn_drug_A1_pval_resist %>%
  arrange(pval)

## plot all pairs, sorted by p-value
d.DeKegel_top5_cn_drug_A1_pval_resist <- d.DeKegel_top5_cn_drug_A1_pval_resist %>% 
  ungroup() %>%
  unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_cn_drug_A1_pval_resist_signif <- d.DeKegel_top5_cn_drug_A1_pval_resist %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_cn_drug_A1_pval_resist_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_A2_cn_vs_A1_drug_pval_resist_WRST_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_cn_drug_A1_pval_resist_signif,
#                aes(x = A2_cn_bin, y = dependency, fill = A2_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

# d.DeKegel_top5_cn_drug_A1_pval_signif

```



```{r}

## calculate p-vals for drugs targeting A2 vs. A1 CN
# d.DeKegel_top5_cn_drug_A2

d.DeKegel_top5_cn_drug_A2_vs_cn_A1_pval_resist_summary <- d.DeKegel_top5_cn_drug_A2 %>%
  filter(A1_cn_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ A1_cn_bin, alternative = "less")$p.value) 

d.DeKegel_top5_cn_drug_A2_pval_resist <- left_join(d.DeKegel_top5_cn_drug_A2, d.DeKegel_top5_cn_drug_A2_vs_cn_A1_pval_resist_summary, 
                                            by = c("sorted_gene_pair", "compound"))
# d.DeKegel_top5_cn_drug_A2_pval

## plot all pairs, sorted by p-value
d.DeKegel_top5_cn_drug_A2_pval_resist <- d.DeKegel_top5_cn_drug_A2_pval_resist %>% 
  ungroup() %>%
  unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_cn_drug_A2_pval_resist_signif <- d.DeKegel_top5_cn_drug_A2_pval_resist %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_cn_drug_A2_pval_resist_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_A1_cn_vs_A2_drug_pval_resist_WRST_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_cn_drug_A2_pval_resist_signif,
#                aes(x = A1_cn_bin, y = dependency, fill = A1_cn_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()


```
NOTE: last 3 on are cut off (but it's probably fine)


#### Combined expr vs. drug sensitivity

##### Make DFs

```{r}

d.tmp1 <- d.DeKegel_top5_druggable %>%
  dplyr::select(prediction_rank:depmap_hit, A1_drug_tier:druggable_flag)

d.tmp2 <- d.expr_top5_drug %>%
  dplyr::select(depmap_id, rna_expression, entrez_id)

d.tmp3 <- metadata %>%
  dplyr::select(depmap_id, stripped_cell_line_name, primary_disease, subtype_disease,
                lineage, lineage_subtype) %>%
  rename(cell_line = stripped_cell_line_name)

d.DeKegel_top5_druggable_depmap_expr <- d.tmp1 %>%
  ## add gene 1 RNA expr info
  left_join(d.tmp2, by = c("A1_entrez" = "entrez_id")) %>%
  rename(A1_rna_expr = rna_expression) %>%
  ## add gene 2 RNA expr info
  left_join(d.tmp2, by = c("depmap_id" = "depmap_id", "A2_entrez" = "entrez_id")) %>%
  rename(A2_rna_expr = rna_expression) %>%
  ## add cell line info
  left_join(d.tmp3, by = "depmap_id")
d.DeKegel_top5_druggable_depmap_expr

```


```{r}

## calculate ntiles for combined CN

d.DeKegel_top5_druggable_depmap_combined_expr <- d.DeKegel_top5_druggable_depmap_expr %>%
  # mutate(combined_expr = A1_rna_expr + A2_rna_expr) %>%
  mutate(combined_expr = log2((2^A1_rna_expr) + (2^A2_rna_expr))) %>%
  group_by(sorted_gene_pair) %>%
  mutate(combined_expr_bin = ntile(combined_expr, n = 4)) %>%
  mutate(combined_expr_bin = factor(combined_expr_bin, levels = c(1, 2, 3, 4)))

```

```{r}

## add paralog pair information to drug DF
d.drugs <- d.drug_sens_filtered_target %>%
  # filter(target == "CDK19" | target == "CDK8") %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target)# %>%
  # unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
  # dplyr::select(-c(depmap_id, cell_line)) %>%
 # rename(compound_name = name)

d.pairs <- d.DeKegel_top5_druggable_depmap_combined_expr %>%
  dplyr::select(sorted_gene_pair, A1, A2) %>%
  distinct(sorted_gene_pair, .keep_all = TRUE) %>%
  pivot_longer(cols = A1:A2, names_to = "pos", values_to = "gene_name")

d.pairs
d.drugs

## use inner_join to get rid of paralog pairs w/o a drug that targets them
d.drug_pairs <- inner_join(d.pairs, d.drugs, by = c("gene_name" = "target"))
d.drug_pairs

## check for drugs that target both members of a pair
d.drug_pairs %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1)

## get list of double-targeting gene pair and compound names
double_targeting_drugs <- d.drug_pairs %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1) %>%
  unite("double_targeting_compounds", c("sorted_gene_pair", "compound")) %>%
  distinct(double_targeting_compounds) %>%
  pull()

## how many double-targetings will be removed?
d.drug_pairs %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  group_by(rm_flag) %>%
  summarize(n = n())

# around 383214 - this makes sense b/c 663 double-targeting drug/pair combos * ~500 cell lines
# is roughly 300k rows

## remove the double-targetings
d.drug_pairs <- d.drug_pairs %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  filter(rm_flag == FALSE) %>%
  dplyr::select(-c("gene_pair_compound", "rm_flag"))

```


```{r}

## combine DFs 

d.DeKegel_top5_combined_expr_drug_pair <- left_join(d.DeKegel_top5_druggable_depmap_combined_expr, 
                                                  d.drug_pairs, 
                                                  by = c("depmap_id", "sorted_gene_pair")) %>%
  filter(!is.na(dependency)) %>%
  ungroup() %>%
  unite("tmp1", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("tmp2" = paste0("(", round(dose, digits = 2), " uM)")) %>%
  unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
d.DeKegel_top5_combined_expr_drug_pair

```


##### WRST
```{r}

d.DeKegel_top5_combined_expr_drug_pair_pval_summary <- d.DeKegel_top5_combined_expr_drug_pair %>%
  filter(combined_expr_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ combined_expr_bin, alternative = "less")$p.value) 
d.DeKegel_top5_combined_expr_drug_pair_pval_summary

d.DeKegel_top5_combined_expr_drug_pair_pval <- left_join(d.DeKegel_top5_combined_expr_drug_pair,
                                                       d.DeKegel_top5_combined_expr_drug_pair_pval_summary, 
                                            by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_combined_expr_drug_pair_pval

```

##### Add FDR-adjusted p-values to DF

```{r}

pvals <- d.DeKegel_top5_combined_expr_drug_pair_pval %>%
  distinct(sorted_gene_pair, compound, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(pval) %>%
  pull()

fdr_vals <- p.adjust(pvals, method = "BH")
head(fdr_vals)

d.fdr_vals <- tibble(fdr = fdr_vals)

d.fdr_vals %>%
  filter(fdr < 0.05) %>%
  nrow()

d.fdr_vals %>%
  filter(fdr < 0.1) %>%
  nrow()

d.pvals_labels <- d.DeKegel_top5_combined_expr_drug_pair_pval %>%
  distinct(sorted_gene_pair, compound, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(sorted_gene_pair, compound) 
d.pvals_labels

d.fdr_vals

d.fdr_vals_labeled <- d.pvals_labels %>%
  add_column(d.fdr_vals)
d.fdr_vals_labeled

d.DeKegel_top5_combined_expr_drug_pair <- d.DeKegel_top5_combined_expr_drug_pair %>%
  left_join(d.fdr_vals_labeled, by = c("sorted_gene_pair", "compound"))
d.DeKegel_top5_combined_expr_drug_pair

## filtered DF with just FDR < 0.1
d.DeKegel_top5_combined_expr_drug_pair_fdr_signif <- d.DeKegel_top5_combined_expr_drug_pair %>%
  filter(fdr < 0.1)

nrow(d.DeKegel_top5_combined_expr_drug_pair_fdr_signif)
d.DeKegel_top5_combined_expr_drug_pair_fdr_signif

```


##### Plot
```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_combined_expr_drug_pair_pval <- d.DeKegel_top5_combined_expr_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_combined_expr_drug_pair_pval_signif <- d.DeKegel_top5_combined_expr_drug_pair_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_combined_expr_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_expr_vs_drug_sens_WRST_pval_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_expr_drug_pair_pval_signif,
#                aes(x = combined_expr_bin, y = dependency, fill = combined_expr_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

```


```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_combined_expr_drug_pair_pval <- d.DeKegel_top5_combined_expr_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_combined_expr_drug_pair_pval_signif <- d.DeKegel_top5_combined_expr_drug_pair_pval %>% 
  filter(pval <= 0.005)

length <- d.DeKegel_top5_combined_expr_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_expr_fixed_vs_drug_sens_WRST_pval_signif_plus_expr_pL0.005.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_expr_drug_pair_pval_signif,
#                aes(x = combined_expr_bin, y = dependency, fill = combined_expr_bin)) +
#     geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(x = "Combined_expr_bin",
#          y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_combined_expr_drug_pair_pval_signif,
#                aes(x = combined_expr_bin, y = combined_expr, fill = combined_expr_bin)) +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(x = "Combined_expr_bin", 
#          y = "Combined_expression") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```

###### FDR signif

```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_combined_expr_drug_pair_fdr_signif <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, fdr),
         "sorted_gene_pair" = reorder(sorted_gene_pair, fdr)) #%>%
  # mutate(combined_expr_bin = factor(combined_expr_bin, levels = c(1, 2, 3, 4)))

length <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_expr_fixed_vs_drug_sens_WRST_pval_signif_plus_expr_fdrL0.1.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_expr_drug_pair_fdr_signif,
#                aes(x = combined_expr_bin, y = dependency, fill = combined_expr_bin)) +
#     geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_expr_bin",
#          y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_combined_expr_drug_pair_fdr_signif,
#                aes(x = combined_expr_bin, y = combined_expr, fill = combined_expr_bin)) +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_expr_bin",
#          y = "Combined_expression") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```


```{r}

## calculate difference in mean/median dependency between Q1 and Q4 
## log2 fold change or not???
## make volcano plot of that vs. FDR
d.DeKegel_top5_combined_expr_drug_pair 

d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr <- d.DeKegel_top5_combined_expr_drug_pair %>%
  filter(combined_expr_bin == 1 | combined_expr_bin == 4) %>% # get only bins 1 & 4; update to min & max
  group_by(sorted_gene_pair, compound, combined_expr_bin) %>%
  mutate(median_dependency = median(dependency)) %>%
  dplyr::select(prediction_rank:depmap_hit, combined_expr_bin, compound, 
                compound_name:moa, median_dependency, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound, combined_expr_bin)), .keep_all = TRUE) %>%
  ungroup()
d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr

d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr%>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n())
  # pivot_wider(names_from = combined_cn_bin,
  #             names_glue = "Q{combined_cn_bin}_{.value}",
  #             values_from = dependency)
  # group_by(sorted_gene_pair, compound) %>%
  # summarize()

d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr_wide <- d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr %>%
  # group_by(sorted_gene_pair, compound) %>%
  pivot_wider(id_cols = c(sorted_gene_pair, compound, gene_pair_compound_label,
                          compound_name, moa, fdr), 
              names_from = combined_expr_bin, 
              names_glue = "Q{combined_expr_bin}_{.value}",
              values_from = median_dependency) %>%
  mutate(lfc_dependency_Q1_v_Q4 = Q1_median_dependency - Q4_median_dependency)
d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr_wide

```

```{r}

d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr_wide %>%
  filter(fdr < 0.1)

d.phase1_expr_volcano_plot <- d.DeKegel_top5_combined_expr_drug_pair_median_dependency_fdr_wide %>%
  filter(lfc_dependency_Q1_v_Q4 < 0) %>%
  unite(c(sorted_gene_pair, compound_name), col = new_label, sep = "\n", remove = FALSE)

phase1_expr_labels_1 <- d.phase1_expr_volcano_plot %>%
  filter(fdr < 0.1 & fdr >= 0.01) %>%
  pull(new_label)

phase1_expr_labels_2 <- d.phase1_expr_volcano_plot %>%
  filter(fdr < 0.01) %>%
  pull(new_label)

ggplot(d.phase1_expr_volcano_plot, aes(x = lfc_dependency_Q1_v_Q4, y = -log10(fdr))) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(color = ifelse(d.phase1_expr_volcano_plot$fdr < 0.1, "black", "gray50")) +
  geom_label_repel(data = subset(d.phase1_expr_volcano_plot, fdr < 0.1 & fdr >= 0.01),
                   aes(label = phase1_expr_labels_1), 
                   segment.size = 0.2,
                   force = 1,
                   direction = "both",
                   size = 2.5, 
                   alpha = 0.8, 
                   max.overlaps = Inf) +
  geom_label_repel(data = subset(d.phase1_expr_volcano_plot, fdr < 0.01),
                   aes(label = phase1_expr_labels_2), 
                   segment.size = 0.2,
                   force = 0.5,
                   direction = "both",
                   # nudge_y = -0.5, 
                   nudge_x = 0.1,
                   size = 2.5, 
                   alpha = 0.8, 
                   max.overlaps = Inf) +
  theme_bw() +
  theme(aspect.ratio = 0.75,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "d.DeKegel_top5_combined_expr_drug_pair_median_dependency_lfc_fdr_volcano_plot.pdf"),
#        width = 6, height = 4, useDingbats = FALSE)

```

#### Phase 2 combined expr
```{r}

d.combined_expr_FDR_signif <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  distinct(across(c(sorted_gene_pair, compound)))
d.combined_expr_FDR_signif

combined_expr_FDR_signif_drugs <- d.combined_expr_FDR_signif %>%
  # dplyr::select(compound) %>%
  separate(col = compound, into = c("id", "dose", "other"), sep = "::") %>%
  dplyr::select(sorted_gene_pair, id) %>%
  distinct() %>%
  pull(id)
combined_expr_FDR_signif_drugs

## get relevant columns from AUC df
d.tmp2 <- d.Broad_secondary_auc %>%
  dplyr::select(broad_id, depmap_id, auc) %>%
  rename(compound_id = broad_id)
d.tmp2

## combine with CN df
d.tmp1 <- d.DeKegel_top5_combined_expr_drug_pair %>%
  dplyr::select(prediction_rank, prediction_percentile, sorted_gene_pair:gene_name,
                compound, compound_name, moa) %>%
  separate(col = compound, into = c("compound_id", "dose", "other"), sep = "::") %>%
  dplyr::select(-c(dose, other)) %>%
  distinct(across(c(depmap_id, sorted_gene_pair, compound_id)), .keep_all = TRUE)
d.tmp1
## 1,173,337 rows => 1,173,337 rows ??

## join CN info with secondary AUC data

# d.tmp1
# d.tmp2

d.DeKegel_top5_depmap_combined_expr_phase2_drug <- right_join(d.tmp1, d.tmp2, by = c("depmap_id", "compound_id")) %>%
  filter(!is.na(auc)) %>%
  ungroup() %>%
  unite("gene_pair_compound_label", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE)
d.DeKegel_top5_depmap_combined_expr_phase2_drug

```



```{r}

## WRST => add p-val to DF
d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_summary <- d.DeKegel_top5_depmap_combined_expr_phase2_drug %>%
  filter(combined_expr_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound_id) %>%
  summarize("pval" = wilcox.test(auc ~ combined_expr_bin, alternative = "less")$p.value)
d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_summary

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval <- left_join(d.DeKegel_top5_depmap_combined_expr_phase2_drug, 
                                                                d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_summary, 
                                                                by = c("sorted_gene_pair", "compound_id"))
d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval

```

```{r}

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval %>%
  distinct(gene_pair_compound_label, .keep_all = TRUE) %>%
  arrange(pval)

d.drug_pair_expr_fdr_signif_phase1 <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  separate(col = compound, into = c("compound_id", "dose", "other"), sep = "::") %>%
  dplyr::select(-c(dose, other)) %>%
  distinct(across(c(sorted_gene_pair, compound_id)))
d.drug_pair_expr_fdr_signif_phase1

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 <- semi_join(d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval, d.drug_pair_expr_fdr_signif_phase1,
          by = c("sorted_gene_pair", "compound_id"))

```

```{r}

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1


pvals <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  distinct(sorted_gene_pair, compound_id, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(pval) %>%
  pull()

fdr_vals <- p.adjust(pvals, method = "BH")
head(fdr_vals)

d.fdr_vals <- tibble(fdr = fdr_vals)

d.fdr_vals %>%
  filter(fdr < 0.05) %>%
  nrow()

d.fdr_vals %>%
  filter(fdr < 0.1) %>%
  nrow()

d.pvals_labels <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  distinct(sorted_gene_pair, compound_id, .keep_all = TRUE) %>%
  arrange(pval) %>%
  dplyr::select(sorted_gene_pair, compound_id) 
d.pvals_labels

d.fdr_vals

d.fdr_vals_labeled <- d.pvals_labels %>%
  add_column(d.fdr_vals)
d.fdr_vals_labeled

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  left_join(d.fdr_vals_labeled, by = c("sorted_gene_pair", "compound_id"))
d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1


```

###### Plot

```{r}

## plot all FDR < 0.1 pairs (sorted by FDR)
## add my own labels!!

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval)) #%>%
  # mutate(combined_expr_bin = factor(combined_expr_bin, levels = c(1, 2, 3, 4)))

length <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()

# d.fdr_labels <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
#   ungroup() %>%
#   dplyr::select(gene_pair_compound_label, combined_cn_bin, fdr)
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1,
#                aes(x = combined_expr_bin, y = auc, fill = combined_expr_bin)) +
#     # geom_hline(yintercept = 0) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "less", p.adjust.method = "BH"),
#               # annotations = fdr_labels, # fix this to get FDR plotted direclty
#               textsize = 3.2) +
#   # add_pvalue(d.fdr_labels) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_expr_bin",
#          y = "Dose_response_AUC") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
# 
#   q <- ggplot(d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1,
#                aes(x = combined_expr_bin, y = combined_expr, fill = combined_expr_bin)) +
#     # geom_hline(yintercept = 4) +
#     # geom_hline(yintercept = 3, linetype = "dashed") +
#     # geom_hline(yintercept = 5, linetype = "dashed") +
#   geom_boxplot() +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   # scale_y_continuous(expand = expansion(mult = 0.15)) +
#   scale_fill_brewer(palette = "YlGnBu") +
#     labs(x = "Combined_expr_bin",
#          y = "Combined_expr") +
#   coord_trans(y = "log2") +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(ggarrange(p, q, ncol = 2, align = "hv"))
# }
# dev.off()

```

```{r}

## get FDR from phase 1, p-val from Phase 2 (adjust for 20 tests?)
# d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%

## adjust p-vals
d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1
d.tmp1 <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  dplyr::select(gene_pair_compound_label, sorted_gene_pair, compound_id, compound_name, moa, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound_id)), .keep_all = TRUE) %>%
  rename(phase2_fdr = fdr)
d.tmp1

## plot scatterplot of drug/gene pair FDR correlation
d.DeKegel_top5_combined_expr_drug_pair_fdr_signif
d.tmp2 <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  separate(col = compound, into = c("compound_id", "dose_rm", "null"), sep = "::") %>%
  dplyr::select(-c(dose_rm, null)) %>%
  dplyr::select(sorted_gene_pair, compound_id, fdr) %>%
  distinct(across(c(sorted_gene_pair, compound_id)), .keep_all = TRUE) %>%
  rename(phase1_fdr = fdr)
d.tmp2

d.combined_expr_phase1_fdr_signif_v_phase2_fdr <- left_join(d.tmp1, d.tmp2, 
                                                          by = c("sorted_gene_pair", "compound_id"))
d.combined_expr_phase1_fdr_signif_v_phase2_fdr

```


```{r}

d.combined_expr_phase1_fdr_signif_v_phase2_fdr

d.combined_expr_phase1_fdr_signif_v_phase2_fdr %>%
  filter(phase2_fdr < 0.1)

phase1_v_phase2_expr_fdr_labels <- d.combined_expr_phase1_fdr_signif_v_phase2_fdr %>%
  pull(gene_pair_compound_label)

ggplot(d.combined_expr_phase1_fdr_signif_v_phase2_fdr, aes(x = -log10(phase1_fdr), y = -log10(phase2_fdr))) +
  geom_hline(yintercept = 1, linetype = "dashed") +
  # geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(color = ifelse(d.combined_expr_phase1_fdr_signif_v_phase2_fdr$phase2_fdr < 0.1, "black", "gray50")) +
  geom_label_repel(data = d.combined_expr_phase1_fdr_signif_v_phase2_fdr,
                   aes(label = gene_pair_compound_label), 
                   segment.size = 0.2,
                   force = 1,
                   nudge_x = 0.5,
                   nudge_y = 0.5,
                   size = 2.5, 
                   alpha = 0.8, 
                   max.overlaps = Inf) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "d.DeKegel_top5_combined_expr_drug_pair_phase1_fdr_v_phase2_fdr.pdf"),
#        width = 4.5, height = 4.5, useDingbats = FALSE)


```

```{r}


# ggsave(file.path(out_dir, "d.DeKegel_top5_combined_expr_drug_pair_phase1_fdr_v_phase2_fdr_lineage.pdf"),
#        width = 6, height = (3*15), useDingbats = FALSE)

length <- d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  ungroup() %>%
  distinct(sorted_gene_pair) %>%
  nrow()

# d.fdr_labels <- d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1 %>%
#   ungroup() %>%
#   dplyr::select(gene_pair_compound_label, combined_cn_bin, fdr)
  
aspect_ratio <- 0.8
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1_lineage.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   print(
#     d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
#     filter(combined_expr_bin == 1 | combined_expr_bin == 4) %>%
#     ggplot(aes(x = lineage, fill = combined_expr_bin)) +
#     geom_bar(aes(y = (..count..)/sum(..count..)), 
#                    position = position_dodge(0.9), 
#                    width = 0.8,
#                    color = "black", 
#                    size = 0.25) +
#     # scale_fill_brewer(palette = "YlGnBu") +
#     scale_fill_manual(values = c("1" = "#FFFFCC", "4" = "#225EA8"), 
#                       labels = c("1" = "lowest", "4" = "highest")) +
#     theme_bw() +
#     theme(aspect.ratio = 0.5,
#           axis.text.x = element_text (angle = 45, vjust = 1, hjust = 1),
#           axis.text = element_text(color = "black"),
#           axis.ticks = element_line(color = "black")) +
#     facet_wrap_paginate(~sorted_gene_pair, scales = "free", ncol = 1, nrow = 1, page = i)
#   )
# }
# dev.off()

```

```{r}

d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1 %>%
  # filter(combined_expr_bin == 1 | combined_expr_bin == 4) %>%
  group_by(sorted_gene_pair, combined_expr_bin) %>%
  summarize(n = n())

d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  group_by(sorted_gene_pair, combined_expr_bin) %>%
  summarize(n = n())

d.DeKegel_top5_druggable_depmap_combined_expr %>%
  group_by(sorted_gene_pair, combined_expr_bin) %>%
  summarize(n =  n())

d.DeKegel_top5_combined_expr_drug_pair %>%
  group_by(sorted_gene_pair, combined_expr_bin) %>%
  summarize(n = n())

```

### Overall trends
```{r}

# write_rds(d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1,
#           file.path(out_dir, "d.DeKegel_top5_depmap_combined_cn_phase2_drug_pval_fdr_signif_phase1"))
# write_rds(d.combined_cn_phase1_fdr_signif_v_phase2_fdr,
#           file.path(out_dir, "d.combined_cn_phase1_fdr_signif_v_phase2_fdr"))

d.combined_cn_phase1_fdr_signif_v_phase2_fdr

d.DeKegel_top5_combined_cn_drug_pair_fdr_signif
d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  filter(sorted_gene_pair == "AURKA_AURKC" & compound_name == "PF-03814735") %>%
  filter(combined_cn_bin == 1 | combined_cn_bin == 4) %>%
  group_by(combined_cn_bin, lineage) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  arrange(lineage)

d.AURKA_AURKC_CN_plot <- d.DeKegel_top5_combined_cn_drug_pair_fdr_signif %>%
  filter(sorted_gene_pair == "AURKA_AURKC" & compound_name == "PF-03814735") %>%
  filter(combined_cn_bin == 1 | combined_cn_bin == 4) %>%
  group_by(combined_cn_bin, lineage) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  arrange(lineage)

d.add_rows <- tibble(combined_cn_bin = c(4, 1, 4, 1),
                   lineage = c("fibroblast", "liver", "peripheral_nervous_system", "thyroid"),
                   n = c(0, 0, 0, 0), 
                   percent = c(0, 0, 0, 0)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 4)))

d.AURKA_AURKC_CN_plot <- bind_rows(d.AURKA_AURKC_CN_plot, d.add_rows)


ggplot(d.AURKA_AURKC_CN_plot, aes(x = lineage, y = percent, fill = combined_cn_bin)) +
  geom_bar(stat = "identity", 
           position = position_dodge(0.9),
           width = 0.8,
           color = "black",
           size = 0.25) +
    # scale_fill_brewer(palette = "YlGnBu") +
    scale_fill_manual(values = c("1" = "#FFFFCC", "4" = "#225EA8"),
                      labels = c("1" = "lowest", "4" = "highest")) +
    theme_bw() +
    theme(aspect.ratio = 0.5,
          axis.text.x = element_text (angle = 45, vjust = 1, hjust = 1),
          axis.text = element_text(color = "black"),
          axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "AURKA_AURKC_CN_bins_1_and_4_vs_lineage.pdf"),
#        height = 4, width = 8, useDingbats = FALSE)

```


```{r}

d.combined_expr_phase1_fdr_signif_v_phase2_fdr
  
d.DeKegel_top5_combined_expr_drug_pair_fdr_signif

# write_rds(d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1, 
#           file.path(out_dir, "d.DeKegel_top5_depmap_combined_expr_phase2_drug_pval_fdr_signif_phase1"))
# write_rds(d.combined_expr_phase1_fdr_signif_v_phase2_fdr, 
#           file.path(out_dir, "d.combined_expr_phase1_fdr_signif_v_phase2_fdr"))

d.ABL1_ABL2_expr_plot <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  filter(sorted_gene_pair == "ABL1_ABL2" & compound_name == "saracatinib") %>%
  filter(combined_expr_bin == 1 | combined_expr_bin == 4) %>%
  group_by(combined_expr_bin, lineage) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  arrange(lineage)

d.add_rows <- tibble(combined_cn_bin = c(1, 1, 1, 4, 1, 1),
                   lineage = c("bone", "fibroblast", "peripheral_nervous_system", "prostate", "skin", "thyroid"),
                   n = c(0, 0, 0, 0, 0, 0), 
                   percent = c(0, 0, 0, 0, 0, 0)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 4)))

d.ABL1_ABL2_expr_plot <- bind_rows(d.ABL1_ABL2_expr_plot, d.add_rows)

ggplot(d.ABL1_ABL2_expr_plot, aes(x = lineage, y = percent, fill = combined_expr_bin)) +
  geom_bar(stat = "identity",
           position = position_dodge(0.9),
           width = 0.8,
           color = "black",
           size = 0.25) +
    # scale_fill_brewer(palette = "YlGnBu") +
    scale_fill_manual(values = c("1" = "#FFFFCC", "4" = "#225EA8"),
                      labels = c("1" = "lowest", "4" = "highest")) +
    theme_bw() +
    theme(aspect.ratio = 0.5,
          axis.text.x = element_text (angle = 45, vjust = 1, hjust = 1),
          axis.text = element_text(color = "black"),
          axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "ABL1_ABL2_expr_bins_1_and_4_vs_lineage.pdf"),
#        height = 4, width = 8, useDingbats = FALSE)

```

```{r}

d.FYN_SRC_expr_plot <- d.DeKegel_top5_combined_expr_drug_pair_fdr_signif %>%
  filter(sorted_gene_pair == "FYN_SRC" & compound_name == "vandetanib") %>%
  filter(combined_expr_bin == 1 | combined_expr_bin == 4) %>%
  group_by(combined_expr_bin, lineage) %>%
  summarize(n = n()) %>%
  mutate(percent = (n / sum(n))*100) %>%
  arrange(lineage)

d.add_rows <- tibble(combined_cn_bin = c(1, 1, 4, 1),
                   lineage = c("fibroblast", "peripheral_nervous_system", "prostate", "skin"),
                   n = c(0, 0, 0, 0),
                   percent = c(0, 0, 0, 0)) %>%
  mutate(combined_cn_bin = factor(combined_cn_bin, levels = c(1, 4)))

d.FYN_SRC_expr_plot <- bind_rows(d.FYN_SRC_expr_plot, d.add_rows)

ggplot(d.FYN_SRC_expr_plot, aes(x = lineage, y = percent, fill = combined_expr_bin)) +
  geom_bar(stat = "identity",
           position = position_dodge(0.9),
           width = 0.8,
           color = "black",
           size = 0.25) +
    # scale_fill_brewer(palette = "YlGnBu") +
    scale_fill_manual(values = c("1" = "#FFFFCC", "4" = "#225EA8"),
                      labels = c("1" = "lowest", "4" = "highest")) +
    theme_bw() +
    theme(aspect.ratio = 0.5,
          axis.text.x = element_text (angle = 45, vjust = 1, hjust = 1),
          axis.text = element_text(color = "black"),
          axis.ticks = element_line(color = "black"))
# ggsave(file.path(out_dir, "FYN_SRC_expr_bins_1_and_4_vs_lineage.pdf"),
#        height = 4, width = 8, useDingbats = FALSE)

```


#### Lung only (comb. expr)
```{r}

## calculate ntiles for combined CN

d.DeKegel_top5_druggable_depmap_lung_combined_expr <- d.DeKegel_top5_druggable_depmap_expr %>%
  filter(lineage == "lung") %>%
  mutate(combined_rna_expr = A1_rna_expr + A2_rna_expr) %>%
  group_by(sorted_gene_pair) %>%
  mutate(combined_expr_bin = ntile(combined_rna_expr, n = 4)) %>%
  mutate(combined_expr_bin = factor(combined_expr_bin, levels = c(4, 3, 2, 1)))

```

```{r}

## add paralog pair information to drug DF
d.drugs <- d.drug_sens_filtered_target %>%
  # filter(target == "CDK19" | target == "CDK8") %>%
  dplyr::select(depmap_id, cell_line, compound, dependency, compound_name, dose, moa, target) #%>%
  # unite(cell_line_gene, c(depmap_id, target), sep = "_", remove = FALSE) %>%
  # dplyr::select(-c(depmap_id, cell_line)) %>%
  #rename(compound_name = name)

d.pairs_lung <- d.DeKegel_top5_druggable_depmap_lung_combined_expr %>%
  dplyr::select(sorted_gene_pair, A1, A2) %>%
  distinct(sorted_gene_pair, .keep_all = TRUE) %>%
  pivot_longer(cols = A1:A2, names_to = "pos", values_to = "gene_name")

## use inner_join to get rid of paralog pairs w/o a drug that targets them
d.drug_pairs_lung <- inner_join(d.pairs_lung, d.drugs, by = c("gene_name" = "target"))
d.drug_pairs_lung

## check for drugs that target both members of a pair
d.drug_pairs_lung %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1)

## get list of double-targeting gene pair and compound names
double_targeting_drugs <- d.drug_pairs_lung %>%
  distinct(sorted_gene_pair, compound, pos, .keep_all = TRUE) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize(n = n()) %>%
  filter(n >1) %>%
  unite("double_targeting_compounds", c("sorted_gene_pair", "compound")) %>%
  distinct(double_targeting_compounds) %>%
  pull()

## how many double-targetings will be removed?
d.drug_pairs_lung %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  group_by(rm_flag) %>%
  summarize(n = n())

# around 383214 - this makes sense b/c 663 double-targeting drug/pair combos * ~500 cell lines
# is roughly 300k rows

## remove the double-targetings
d.drug_pairs_lung <- d.drug_pairs_lung %>%
  unite("gene_pair_compound", c("sorted_gene_pair", "compound"), remove = FALSE) %>%
  mutate(rm_flag = case_when(
    gene_pair_compound %in% double_targeting_drugs & pos == "A2" ~ TRUE,
    TRUE ~ FALSE)) %>% # otherwise, keep
  filter(rm_flag == FALSE) %>%
  dplyr::select(-c("gene_pair_compound", "rm_flag"))

```


```{r}

## combine DFs 
d.DeKegel_top5_lung_combined_expr_drug_pair <- left_join(d.DeKegel_top5_druggable_depmap_lung_combined_expr, 
                                                       d.drug_pairs_lung, 
                                                       by = c("depmap_id", "sorted_gene_pair")) %>%
  filter(!is.na(dependency)) %>%
  ungroup() %>%
  unite("tmp1", c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("tmp2" = paste0("(", round(dose, digits = 2), " uM)")) %>%
  unite("gene_pair_compound_label", c("tmp1", "tmp2"), sep = " ", remove = TRUE)
d.DeKegel_top5_lung_combined_expr_drug_pair

```


##### WRST
```{r}

d.DeKegel_top5_lung_combined_expr_drug_pair_pval_summary <- d.DeKegel_top5_lung_combined_expr_drug_pair %>%
  filter(combined_expr_bin %in% c(1, 4)) %>%
  group_by(sorted_gene_pair, compound) %>%
  summarize("pval" = wilcox.test(dependency ~ combined_expr_bin, alternative = "greater")$p.value) 
# d.DeKegel_top5_lung_combined_expr_drug_pair_pval_summary

d.DeKegel_top5_lung_combined_expr_drug_pair_pval <- left_join(d.DeKegel_top5_lung_combined_expr_drug_pair,
                                                            d.DeKegel_top5_lung_combined_expr_drug_pair_pval_summary, 
                                                            by = c("sorted_gene_pair", "compound"))
# d.DeKegel_top5_lung_combined_expr_drug_pair_pval

```

##### Plot
```{r}

## plot all pairs, sorted by p-value
d.DeKegel_top5_lung_combined_expr_drug_pair_pval <- d.DeKegel_top5_lung_combined_expr_drug_pair_pval %>% 
  ungroup() %>%
  # unite(gene_pair_compound_label, c("sorted_gene_pair", "compound_name"), sep = "\n", remove = FALSE) %>%
  mutate("gene_pair_compound_label" = reorder(gene_pair_compound_label, pval),
         "sorted_gene_pair" = reorder(sorted_gene_pair, pval))

d.DeKegel_top5_lung_combined_expr_drug_pair_pval_signif <- d.DeKegel_top5_lung_combined_expr_drug_pair_pval %>% 
  filter(pval < 0.05)

length <- d.DeKegel_top5_lung_combined_expr_drug_pair_pval_signif %>%
  ungroup() %>%
  distinct(gene_pair_compound_label) %>%
  nrow()
  
n_rows <- 3
n_cols <- 3
n_pages <- ceiling(length/(n_rows*n_cols))
# 
# pdf(file.path(out_dir, "DeKegel_top5_lung_combined_expr_vs_drug_sens_WRST_pval_signif.pdf"))
# for(i in 1:n_pages){
#   p <-  ggplot(d.DeKegel_top5_combined_expr_drug_pair_pval_signif,
#                aes(x = combined_expr_bin, y = dependency, fill = combined_expr_bin)) +
#   geom_boxplot() +
#   geom_signif(comparisons = list(c(1, 4)),
#               map_signif_level = FALSE,
#               test = "wilcox.test",
#               test.args = list(alternative = "greater"),
#               textsize = 3.2) +
#   ## adds 10% of space on top & bottom so p-value label will fit
#   scale_y_continuous(expand = expansion(mult = 0.1)) +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#     labs(y = "LFC_treated_vs_DMSO") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~gene_pair_compound_label, scales = "free_y",
#                       nrow = n_rows, ncol = n_cols, page = i)
#   print(p)
# }
# dev.off()

```


### Combined CN vs. expression

* filter out multiples of cell lines!!!
* plot correlation values b/w CN & expression (r or r^2?)

```{r}

d.DeKegel_top5_combined_cn_drug_pair_pval

d.DeKegel_top5_combined_expr_drug_pair_pval

# d.cn_vs_expr <- inner_join(d.DeKegel_top5_combined_cn_drug_pair_pval, 
#                           d.DeKegel_top5_combined_expr_drug_pair_pval, 
#                           by = c("sorted_gene_pair", "depmap_id")) %>%
#   filter(!is.na(combined_cn)) %>%
#   filter(!is.na(combined_expr))
# d.cn_vs_expr

d.tmp1 <- d.DeKegel_top5_combined_cn_drug_pair_pval %>%
  dplyr::select(depmap_id, sorted_gene_pair, combined_log_cn) 

d.tmp2 <- d.DeKegel_top5_combined_expr_drug_pair_pval %>%
  dplyr::select(depmap_id, sorted_gene_pair, combined_expr)

d.tmp3 <- inner_join(d.tmp1, d.tmp2, by = c("depmap_id", "sorted_gene_pair")) %>%
  drop_na()
d.tmp3

```

```{r}

## HDAC1/2 example - get cor

d.tmp3 %>%
  filter(sorted_gene_pair == "HDAC1_HDAC2") %>%
  dplyr::select(combined_log_cn, combined_expr) %>%
  cor() #%>%
  # pull(combined_expr)

HDAC_lm <- lm(data = d.tmp3, combined_expr ~ combined_log_cn)
summary(HDAC_lm)

d.tmp3 %>%
  filter(sorted_gene_pair == "HDAC1_HDAC2")

```


```{r}

## HDAC1/2 plot

# d.tmp3 %>%
#   filter(sorted_gene_pair == "HDAC1_HDAC2") %>%
#   ggplot(aes(x = combined_log_cn, y = combined_expr)) +
#   geom_point() +
#   geom_smooth(method = "lm", se = FALSE) +
#   labs(x = "combined_log2_cn", 
#        y = "combined_log2_expr") +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black")) +
#   facet_wrap(~sorted_gene_pair)

# ggsave(file.path(out_dir, "DeKegel_top5_combined_cn_vs_combined_expr_DepMap_HDAC1_HDAC2.pdf"),
#         width = 4, height = 4)


# contour.pal <- colorRampPalette(brewer.pal(n = 9, name ="Spectral"))(50)
d.tmp3 %>%
  filter(sorted_gene_pair == "HDAC1_HDAC2") %>%
  ggplot(aes(x = combined_log_cn, y = combined_expr)) +
  geom_point() +
  # geom_density2d(aes(color = ..level..), alpha = 0.7) +
  geom_text(mapping = aes(x = -Inf, y = Inf, label = paste0("r=", 0.565)),
            hjust = -0.25, vjust = 1.75, size = 3) +
  # geom_smooth(method = "lm", se = FALSE) +
  labs(x = "combined_log2_cn", 
       y = "combined_log2_expr") +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black")) +
  facet_wrap(~sorted_gene_pair)

ggsave(file.path(out_dir, "DeKegel_top5_combined_cn_vs_combined_expr_DepMap_HDAC1_HDAC2_cor.pdf"),
        width = 4, height = 4)

```

```{r}

## all top 5% paralogs

d.tmp3 %>%
  ggplot(aes(x = combined_log_cn, y = combined_expr)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "combined_log2_cn", 
       y = "combined_log2_expr") +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"))

# ggsave(file.path(out_dir, "DeKegel_top5_combined_cn_vs_combined_expr_DepMap_cell_lines.pdf"),
#         width = 4, height = 4)

```

```{r}



```


```{r}

length <- d.tmp3 %>%
  ungroup() %>%
  distinct(sorted_gene_pair) %>%
  nrow()
  
aspect_ratio <- 1
n_rows <- 1
n_cols <- 1
n_pages <- ceiling(length/(n_rows*n_cols))

# pdf(file.path(out_dir, "DeKegel_top5_combined_expr_vs_combined_cn.pdf"),
#     width = 4, height = 2.5)
# for(i in 1:n_pages){
#   p <-  ggplot(d.tmp3, aes(x = combined_log_cn, y = combined_expr)) +
#   geom_point() +
#   theme_bw() +
#   theme(aspect.ratio = aspect_ratio,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none") +
#   facet_wrap_paginate(~sorted_gene_pair, scales = "free",
#                       nrow = n_rows, ncol = n_cols, page = i)
#     print(ggarrange(p, ncol = 1))
# }
# dev.off()

```

### Quartiles vs. CN/expr
```{r}

d.DeKegel_top5_combined_expr_drug_pair %>%
  ggplot(aes(x = combined_expr_bin, y = combined_expr, fill = combined_expr_bin)) +
  geom_boxplot() +
  # geom_signif(comparisons = list(c(1, 4)),
  #             map_signif_level = FALSE,
  #             test = "wilcox.test",
  #             test.args = list(alternative = "greater"),
  #             textsize = 3.2) +
  ## adds 10% of space on top & bottom so p-value label will fit
  # scale_y_continuous(expand = expansion(mult = 0.1)) +
  scale_fill_brewer(palette = "YlGnBu", direction = -1) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none")
# ggsave(file.path(out_dir, "DepMap_CN_vs_CN_quartile_DeKegel_top5_combined_cn_drug.png"),
#        width = 4, height = 3)

d.DeKegel_top5_combined_cn_drug_pair %>%
  filter(!is.na(combined_log_cn)) %>%
  ggplot(aes(x = combined_cn_bin, y = combined_log_cn, fill = combined_cn_bin)) +
  geom_boxplot() +
  # geom_signif(comparisons = list(c(1, 4)),
  #             map_signif_level = FALSE,
  #             test = "wilcox.test",
  #             test.args = list(alternative = "greater"),
  #             textsize = 3.2) +
  ## adds 10% of space on top & bottom so p-value label will fit
  # scale_y_continuous(expand = expansion(mult = 0.1)) +
  scale_fill_brewer(palette = "YlGnBu", direction = -1) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none")
# ggsave(file.path(out_dir, "DepMap_CN_vs_CN_quartile_DeKegel_top5_combined_expr_drug.png"),
#        width = 4, height = 3)

```


```{r}


d.DeKegel_top5_cn_drug_A1 %>%
  ggplot(aes(x = A1_cn_bin, y = A1_log_cn, fill = A1_cn_bin)) +
  geom_boxplot() +
  # geom_signif(comparisons = list(c(1, 4)),
  #             map_signif_level = FALSE,
  #             test = "wilcox.test",
  #             test.args = list(alternative = "greater"),
  #             textsize = 3.2) +
  ## adds 10% of space on top & bottom so p-value label will fit
  # scale_y_continuous(expand = expansion(mult = 0.1)) +
  scale_fill_brewer(palette = "YlGnBu", direction = -1) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none")
# ggsave(file.path(out_dir, "DepMap_CN_vs_CN_quartile_DeKegel_top5_cn_drug_A1.png"),
#        width = 4, height = 3)

d.DeKegel_top5_cn_drug_A2 %>%
  ggplot(aes(x = A2_cn_bin, y = A2_log_cn, fill = A2_cn_bin)) +
  geom_boxplot() +
  # geom_signif(comparisons = list(c(1, 4)),
  #             map_signif_level = FALSE,
  #             test = "wilcox.test",
  #             test.args = list(alternative = "greater"),
  #             textsize = 3.2) +
  ## adds 10% of space on top & bottom so p-value label will fit
  # scale_y_continuous(expand = expansion(mult = 0.1)) +
  scale_fill_brewer(palette = "YlGnBu", direction = -1) +
  theme_bw() +
  theme(aspect.ratio = 1,
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black"),
        legend.position = "none")
# ggsave(file.path(out_dir, "DepMap_CN_vs_CN_quartile_DeKegel_top5_cn_drug_A2.png"),
#        width = 4, height = 3)


```

```{r}

d.DeKegel_top5_druggable_depmap_expr %>%
  rename(A1_hgnc = A1, A2_hgnc = A2) %>%
  pivot_longer(cols = starts_with("A"),
               names_to = c("gene", ".value"),
               names_pattern = "A(.)_(.*)") %>%
group_by(hgnc) %>%
mutate(bin_expr = ntile(rna_expr, 4)) %>%
mutate(bin_expr = factor(bin_expr, levels = c(4, 3, 2, 1))) %>%
ggplot(aes(x = bin_expr, y = rna_expr, fill = bin_expr)) +
geom_boxplot() +
scale_fill_brewer(palette = "YlGnBu", direction = -1) +
theme_bw() +
theme(aspect.ratio = 1,
      axis.text = element_text(color = "black"),
      axis.ticks = element_line(color = "black"),
      legend.position = "none")
# ggsave(file.path(out_dir, "DepMap_expr_vs_expr_quartile_DeKegel_top5_expr_drug.png"),
#        width = 4, height = 3)

```


```{r}

# eh <- ExperimentHub()
# eh.depmap <- query(eh, "depmap")
# 
# metadata <- eh[["EH6122"]]
# cn <- eh[["EH6119"]]
# expr <- eh[["EH6120"]]


```

```{r}

# cn %>%
#   filter(!is.na(log_copy_number)) %>%
#   group_by(gene) %>%
#   mutate(bin_cn = ntile(log_copy_number, 4)) %>%
#   mutate(bin_cn = factor(bin_cn, levels = c(4, 3, 2, 1))) %>%
#   ggplot(aes(x = bin_cn, y = log_copy_number, fill = bin_cn)) +
#   geom_boxplot() +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none")
# # ggsave(file.path(out_dir, "DepMap_CN_vs_CN_quartile_all_genes.png"),
# #        width = 4, height = 3)
# 
# expr %>%
#   filter(!is.na(rna_expression)) %>%
#   group_by(gene) %>%
#   mutate(bin_expr = ntile(rna_expression, 4)) %>%
#   mutate(bin_expr = factor(bin_expr, levels = c(4, 3, 2, 1))) %>%
#   ggplot(aes(x = bin_expr, y = rna_expression, fill = bin_expr)) +
#   geom_boxplot() +
#   scale_fill_brewer(palette = "YlGnBu", direction = -1) +
#   theme_bw() +
#   theme(aspect.ratio = 1,
#         axis.text = element_text(color = "black"),
#         axis.ticks = element_line(color = "black"),
#         legend.position = "none")
# # ggsave(file.path(out_dir, "DepMap_expr_vs_expr_quartile_all_genes.png"),
# #        width = 4, height = 3)

```


### DepMap expression/CN


#### All lineages/diseases
```{r}

gene_list <- c("CDK11A", "CDK11B", "CCNL1", "CCNL2")

## lineage x expression
metadata %>%
  dplyr::select(depmap_id, lineage) %>%
  dplyr::full_join(expr, by = "depmap_id") %>%
  dplyr::filter(gene_name %in% gene_list) %>%
  ggplot(aes(x = lineage, y = rna_expression, fill = lineage)) + 
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none", 
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black")) +
  facet_wrap(~gene_name)

## lineage x CN
metadata %>%
  dplyr::select(depmap_id, lineage) %>%
  dplyr::full_join(cn, by = "depmap_id") %>%
  dplyr::filter(gene_name %in% gene_list) %>%
  ggplot(aes(x = lineage, y = log_copy_number, fill = lineage)) + 
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none", 
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black")) +
  facet_wrap(~gene_name, scales = "free_y")

## primary_disease x expression
metadata %>%
  dplyr::select(depmap_id, primary_disease) %>%
  dplyr::full_join(expr, by = "depmap_id") %>%
  dplyr::filter(gene_name %in% gene_list) %>%
  ggplot(aes(x = primary_disease, y = rna_expression, fill = primary_disease)) + 
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none", 
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black")) +
  facet_wrap(~gene_name)

## primary_disease x CN
metadata %>%
  dplyr::select(depmap_id, primary_disease) %>%
  dplyr::full_join(cn, by = "depmap_id") %>%
  dplyr::filter(gene_name %in% gene_list) %>%
  ggplot(aes(x = primary_disease, y = log_copy_number, fill = primary_disease)) + 
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none", 
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black")) +
  facet_wrap(~gene_name, scales = "free_y")

```

#### Lung only
```{r}

gene_list <- c("CDK11A", "CDK11B", "CCNL1", "CCNL2")

metadata %>%
  dplyr::select(depmap_id, lineage, lineage_subtype, primary_disease) %>%
  dplyr::full_join(expr, by = "depmap_id") %>%
  dplyr::filter(lineage == "lung") %>%
  dplyr::filter(gene_name %in% gene_list) %>%
  ggplot(aes(x = lineage_subtype, y = rna_expression, fill = lineage_subtype)) + 
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none", 
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black")) +
  facet_wrap(~gene_name)

metadata %>%
  dplyr::select(depmap_id, lineage, lineage_subtype) %>%
  dplyr::full_join(cn, by = "depmap_id") %>%
  dplyr::filter(lineage == "lung") %>%
  dplyr::filter(gene_name %in% gene_list) %>%
  ggplot(aes(x = lineage_subtype, y = log_copy_number, fill = lineage_subtype)) + 
  geom_boxplot() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none", 
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black")) +
  facet_wrap(~gene_name, scales = "free_y")


```


```{r}

metadata %>%
  dplyr::select(depmap_id, cell_line, primary_disease) %>%
  dplyr::full_join(mut_calls, by = "depmap_id")

metadata %>%
  dplyr::select(depmap_id, cell_line, lineage, primary_disease, subtype_disease) %>%
  dplyr::full_join(mut_calls, by = "depmap_id") %>%
  dplyr::filter(gene_name %in% gene_list) %>%
  dplyr::filter(is_deleterious == TRUE) %>%
  dplyr::filter(lineage == "lung") %>%
  group_by(primary_disease, gene_name) %>%
  summarize(counts = n()) %>%
  ggplot(aes(x = primary_disease, y = counts, fill = primary_disease)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none", 
        axis.text = element_text(color = "black"),
        axis.ticks = element_line(color = "black")) +
  facet_wrap(~gene_name, scales = "free_y")

metadata %>%
  dplyr::select(depmap_id, cell_line, primary_disease, subtype_disease) %>%
  dplyr::full_join(mut_calls, by = "depmap_id") %>%
  filter(gene_name %in% gene_list) %>%
  filter(primary_disease == "Lung Cancer") %>%
  filter(is_deleterious == TRUE)

head(metadata)


```

I realized that CDK11A, CDK11B, and CCNL2 seemed to be frequently mutated in the same samples. So I checked cBioPortal/TCGA data and saw that they were frequently co-deleted in tumor samples: 
![cBioPortal oncoprint image for CDK11A/B and CCNL1/2 in the TCGA PanCancer Atlas data, cropped to focus on mutated samples.](file.path(in_dir, "images", "TCGA_allLUAD_oncoprint_CDK11_CCNL_cropped.png"))

And that according to the UCSC Genome Browser, they are all located close together on chromosome 1p36.33. 
![UCSC genome browser image of chromosome 1p36.33, which includes CDK11A/B and CCNL2.](file.path(in_dir, "images", "chr1p36.33_genes.png"))














